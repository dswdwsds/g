<!DOCTYPE html>
<html lang="ar">

<head>
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://www.gstatic.com; img-src 'self' data: https://*.discordapp.com https://*.discordapp.net https://*.googleusercontent.com https://lh3.googleusercontent.com https://via.placeholder.com https://ui-avatars.com https://*.ibb.co; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://discord.com https://*.discordapp.com https://www.gstatic.com https://api.imgbb.com; frame-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com;">
    <meta charset="UTF-8">
    <link rel="icon" href="https://ui-avatars.com/api/?name=BR&background=00f2fe&color=000">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙƒ ÙÙŠ Professional GS - ØªØ§Ø¨Ø¹ Ø­Ø§Ù„Ø© Ø·Ù„Ø¨Ø§Øª ØªØ·ÙˆÙŠØ± Ø§Ù„Ø´Ø®ØµÙŠØ§Øª ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ.">
    <title>Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ | Professional GS</title>

    <!-- Optimized Font Loading -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+Arabic:wght@400;700;800&display=swap"
        rel="stylesheet">

    <link rel="stylesheet" href="style.css">
</head>

<body>

    <nav class="nav-bar">
        <div class="user-info" id="userInfo">
            <!-- Auth Content -->
        </div>
        <a href="index.html" class="logo"
            style="text-decoration: none; font-family: var(--font-en); font-weight: 800; color: var(--primary);">PRO
            GS</a>
    </nav>

    <header class="hero" style="padding-top: 120px;">
        <h1 style="font-family: var(--font-ar);">Ø³Ø¬Ù„ Ø·Ù„Ø¨Ø§ØªÙŠ ğŸ“‹</h1>
        <p>Ù‡Ù†Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§ØªÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© ÙˆØ§Ù„Ø­Ø§Ù„ÙŠØ©</p>
    </header>

    <section class="queue-container" style="max-width: 1000px;">
        <div class="queue-card">
            <h2 style="margin-bottom: 20px;">Ø·Ù„Ø¨Ø§ØªÙŠ</h2>
            <div id="historyList" class="queue-list">
                <!-- Orders will appear here -->
            </div>
        </div>
    </section>

    <footer>
        <p><a href="bounty-rush.html" style="color: var(--primary); text-decoration: none;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª</a></p>
    </footer>

    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Chat Modal -->
    <div id="chatModal" class="chat-modal">
        <div class="chat-container">
            <div class="chat-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <div style="position:relative;">
                        <img id="chatTargetAvatar" src=""
                            style="width:35px; height:35px; border-radius:50%; border:1px solid var(--primary)">
                        <div
                            style="position:absolute; bottom:0; right:0; width:10px; height:10px; background:#00ff00; border-radius:50%; border:2px solid #000;">
                        </div>
                    </div>
                    <div>
                        <div id="chatTargetName" style="font-weight:bold; font-size:0.9rem;">Ø§Ù„Ù…ÙˆØ¸Ù</div>
                        <div style="font-size:0.7rem; color:var(--text-dim);">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</div>
                    </div>
                </div>
                <button class="auth-btn" style="background:none; border:none; font-size:1.2rem; padding:0;"
                    onclick="closeChat()">âœ–</button>
            </div>
            <div id="chatMessages" class="chat-messages">
                <div class="chat-empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
            </div>
            <div class="chat-input-area">
                <div class="chat-input-area" style="position:relative;">
                    <div id="uploadProgress" class="upload-progress-container">
                        <div class="upload-progress-bar"></div>
                    </div>
                    <input type="file" id="chatImageInput" accept="image/*" hidden>
                    <button onclick="document.getElementById('chatImageInput').click()" class="chat-send-btn"
                        style="background:rgba(255,255,255,0.1); font-size:1.1rem;">ğŸ“¸</button>
                    <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
                    <button id="sendMessageBtn" class="chat-send-btn">ğŸ•Šï¸</button>
                </div>
            </div>
        </div>

        <!-- Floating Support Button -->
        <a href="https://discord.com/channels/1284591581717987422/1284591582187622539" target="_blank"
            class="floating-support-btn">
            <span>ğŸ§</span>
            <span>ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…</span>
        </a>

        <script type="module">
            import { auth, onAuthStateChanged } from './firebase-config.js';
            import { login, logout, listenToUserOrders, submitRating, sendMessage, listenToMessages, sendImageMessage, listenToUnreadCount, markMessagesAsRead, getUserRole, listenToWorkers } from './app.js?v=2';

            const userInfo = document.getElementById('userInfo');
            const historyList = document.getElementById('historyList');


            const refreshUserUI = () => {
                const user = auth.currentUser;
                if (user) {
                    const userRole = getUserRole(user.email);
                    const isStaff = !!userRole;
                    const workerBadge = isStaff ? `<span class="worker-badge">${userRole === 'admin' ? 'Admin ğŸ‘‘' : 'Staff ğŸ›¡ï¸'}</span>` : '';
                    const workersLink = isStaff
                        ? '<a href="workers.html" class="dropdown-item">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>'
                        : '';

                    userInfo.innerHTML = `
                <div class="user-dropdown">
                    <div class="user-profile">
                        <img src="${user.photoURL}" class="user-avatar" loading="lazy">
                        <span class="user-name">${user.displayName} ${workerBadge}</span>
                    </div>
                    <div class="dropdown-menu">
                        <a href="history.html" class="dropdown-item">ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                        ${workersLink}
                        <a href="#" class="dropdown-item" onclick="handleLogout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
                    </div>
                </div>
            `;
                } else {
                    userInfo.innerHTML = `<button class="auth-btn" onclick="handleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„</button>`;
                }
            };

            listenToWorkers(() => refreshUserUI());

            onAuthStateChanged(auth, (user) => {
                refreshUserUI();
                if (user) {
                    loadHistory(user.uid);
                } else {
                    window.location.href = 'bounty-rush.html';
                }
            });

            window.handleLogin = login;
            window.handleLogout = logout;

            const loadHistory = (uid) => {
                listenToUserOrders(uid, (orders) => {
                    historyList.innerHTML = '';
                    if (orders.length === 0) {
                        historyList.innerHTML = '<p style="text-align:center; color: var(--text-dim);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¨Ø¹Ø¯</p>';
                        return;
                    }

                    orders.sort((a, b) => {
                        const aTime = a.createdAt?.toMillis ? a.createdAt.toMillis() : 0;
                        const bTime = b.createdAt?.toMillis ? b.createdAt.toMillis() : 0;
                        return bTime - aTime;
                    });

                    orders.forEach(order => {
                        const item = document.createElement('div');
                        item.className = `queue-item ${order.status === 'working' ? 'active' : ''} ${order.status === 'done' ? 'done' : ''}`;

                        const statusMap = {
                            'waiting': 'â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡',
                            'working': 'ğŸ”¥ Ø¬Ø§Ø±Ù Ø§Ù„Ø¹Ù…Ù„',
                            'done': 'âœ… Ù…ÙƒØªÙ…Ù„',
                            'rejected': 'âŒ Ù…Ø±ÙÙˆØ¶'
                        };

                        const date = order.createdAt?.toDate ? new Date(order.createdAt.toDate()).toLocaleDateString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

                        const characters = order.characters || [{ name: order.charName, image: order.charImage }];

                        // Show More Logic
                        const limit = 6;
                        const visibleChars = characters.slice(0, limit);
                        const hiddenChars = characters.slice(limit);

                        const generateCharTag = (c, hidden = false) => `
                            <div class="${hidden ? `hidden-char-${order.id}` : ''}" style="${hidden ? 'display:none;' : 'display:inline-flex;'} align-items:center; gap:5px; background:rgba(255,255,255,0.05); padding:4px 10px; border-radius:12px; font-size:0.85rem;">
                                ${c.image ? `<img src="${c.image}" style="width:20px; height:20px; border-radius:50%" loading="lazy">` : 'ğŸ—¡ï¸'}
                                <span>${c.name}</span>
                            </div>
                        `;

                        const visibleTags = visibleChars.map(c => generateCharTag(c)).join(' ');
                        const hiddenTags = hiddenChars.map(c => generateCharTag(c, true)).join(' ');

                        let moreBtn = '';
                        if (hiddenChars.length > 0) {
                            moreBtn = `
                                <button onclick="document.querySelectorAll('.hidden-char-${order.id}').forEach(el => el.style.display='inline-flex'); this.style.display='none';" 
                                    style="background:rgba(0, 242, 254, 0.1); border:1px solid var(--primary); color:white; border-radius:12px; padding:4px 10px; font-size:0.75rem; cursor:pointer;">
                                    Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ (+${hiddenChars.length})
                                </button>
                            `;
                        }

                        // Actions for working orders
                        let actionsHtml = '';
                        if (order.status === 'working' && order.uid === auth.currentUser?.uid) {
                            actionsHtml = `
                                <button onclick="openChat('${order.id}')" class="auth-btn" style="padding: 6px 12px; font-size: 0.8rem; border-radius: 8px; margin-top: 8px; background: #4facfe; color: #fff; border: none;">
                                    ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù ğŸ’¬
                                </button>
                            `;
                        }

                        item.innerHTML = `
                    <div style="display:flex; flex-direction:column; flex:1; gap:12px">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="flex:1">
                                <div style="font-weight:700; color: var(--primary); margin-bottom:5px;">Ø§Ù„ÙØ¦Ø©: ${order.tier}</div>
                                <div style="display:flex; flex-wrap:wrap; gap:8px;">
                                    ${visibleTags}
                                    ${hiddenTags}
                                    ${moreBtn}
                                </div>
                                <div style="font-size:0.75rem; color:var(--text-dim); margin-top:8px;">${date}</div>
                            </div>
                        </div>
                        <div style="font-size:0.7rem; color:var(--text-dim); background: rgba(255,255,255,0.03); padding: 4px 8px; border-radius: 6px; display: inline-block; margin-bottom: 8px;">
                            ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: <span style="color: var(--primary); font-family: monospace;">${order.id}</span>
                        </div>
                        ${order.workerName ? `<div style="font-size:0.75rem; color:var(--primary); font-style:italic;">ğŸ‘¤ Ø¨ÙˆØ§Ø³Ø·Ø©: ${order.workerName}</div>` : ''}
                        ${actionsHtml}
                    </div>
                    <span class="pos-tag" style="display:flex; flex-direction:column; align-items:flex-end; justify-content:center;">
                        ${statusMap[order.status] || order.status}
                    </span>
                `;
                        historyList.appendChild(item);
                    });
                });
            };

            let chatUnsubscribe = null;
            let activeChatOrderId = null;
            let lastOrdersList = []; // To store orders for chat details lookup if needed

            window.openChat = (orderId) => {
                // In history we might not have the full order object handy easily without fetching or storing, 
                // but we passed ID. For simple UI we can just show "Ø§Ù„Ù…ÙˆØ¸Ù".
                // Ideally we find the order in the 'orders' list from the closure, 
                // but since that's inside loadHistory, we might need a global or fetch.
                // For now, let's keep it simple or user dummy avatar.

                activeChatOrderId = orderId;
                document.getElementById('chatTargetName').innerText = "Ø§Ù„Ù…ÙˆØ¸Ù Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„";
                document.getElementById('chatTargetAvatar').src = `https://ui-avatars.com/api/?name=W&background=00f2fe&color=000`;

                const modal = document.getElementById('chatModal');
                modal.classList.add('visible');

                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '<div class="chat-empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';

                if (chatUnsubscribe) chatUnsubscribe();

                chatUnsubscribe = listenToMessages(orderId, (messages) => {
                    // Mark as read
                    markMessagesAsRead(orderId, auth.currentUser.uid);

                    chatMessages.innerHTML = '';
                    if (messages.length === 0) {
                        chatMessages.innerHTML = '<div class="chat-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†! ğŸ‘‹</div>';
                    } else {
                        messages.forEach(msg => {
                            const isMe = msg.senderId === auth.currentUser?.uid;
                            const bubble = document.createElement('div');
                            bubble.className = `message-bubble ${isMe ? 'sent' : 'received'}`;

                            const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '...';

                            bubble.innerHTML = `
                           <div class="message-info">
                             ${!isMe ? `<img src="${msg.senderAvatar}" style="width:15px; height:15px; border-radius:50%">` : ''}
                             <span>${isMe ? 'Ø£Ù†Ø§' : msg.senderName} â€¢ ${time}</span>
                           </div>
                           <div class="message-text">
                             ${msg.text ? `<div>${msg.text}</div>` : ''}
                             ${msg.image ? `
                               <a href="${msg.image}" target="_blank">
                                 <img src="${msg.image}" style="max-width:100%; border-radius:10px; margin-top:5px; border:1px solid var(--glass-border); cursor:pointer;">
                               </a>
                             ` : ''}
                           </div>
                         `;
                            chatMessages.appendChild(bubble);
                        });
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                    }
                });
            };

            window.closeChat = () => {
                document.getElementById('chatModal').classList.remove('visible');
                if (chatUnsubscribe) chatUnsubscribe();
                chatUnsubscribe = null;
                activeChatOrderId = null;
            };

            document.getElementById('sendMessageBtn').onclick = async () => {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (!text || !activeChatOrderId) return;

                input.value = '';
                const success = await sendMessage(activeChatOrderId, text);
                if (!success) {
                    // We need showToast here, let's look if we have it or use alert
                    // alert("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©!");
                    showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©!", "âŒ");
                    input.value = text;
                }
            };

            document.getElementById('chatInput').onkeypress = (e) => {
                if (e.key === 'Enter') document.getElementById('sendMessageBtn').click();
            };

            document.getElementById('chatImageInput').onchange = async (e) => {
                const file = e.target.files[0];
                if (!file || !activeChatOrderId) return;

                if (file.size > 32 * 1024 * 1024) {
                    showToast("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! (Ø§Ù„Ø£Ù‚ØµÙ‰ 32 Ù…ÙŠØ¬Ø§)", "âš ï¸");
                    return;
                }

                // Show progress bar
                const progressBar = document.getElementById('uploadProgress');
                progressBar.style.display = 'block';

                // showToast("Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...", "â³"); // Replace with bar

                const success = await sendImageMessage(activeChatOrderId, file);

                // Hide progress bar
                progressBar.style.display = 'none';

                if (success) {
                    // showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©!", "âœ…");
                } else {
                    showToast("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©!", "âŒ");
                }
                e.target.value = '';
            };

            // UI Helper
            window.showToast = (message, icon = 'â„¹ï¸') => {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = 'toast';
                toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            };
        </script>
</body>

</html>