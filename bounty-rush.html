<!DOCTYPE html>
<html lang="ar">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>One Piece Bounty Rush | Professional GS</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
</head>

<body>

  <nav class="nav-bar">
    <div class="user-info" id="userInfo">
      <!-- Auth Content -->
    </div>
    <div class="logo" style="font-family: var(--font-en); font-weight: 800; color: var(--primary);">PRO GS</div>
  </nav>

  <header class="hero" style="padding-top: 120px;">
    <h1>One Piece Bounty Rush</h1>
    <p>Ù†Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© Ø±ÙØ¹ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø¨Ø³Ø±Ø¹Ø© ÙØ§Ø¦Ù‚Ø© ÙˆØ¶Ù…Ø§Ù† ÙƒØ§Ù…Ù„ Ø¶Ø¯ Ø£ÙŠ Ø®Ù„Ù„.</p>
  </header>

  <section class="queue-container" id="queueDashboard" class="hidden">
    <div class="queue-card">
      <span class="queue-status-tag">Live Queue ğŸ”´</span>
      <h2 style="margin-bottom: 5px;">Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
      <p id="queueBrief" style="color: var(--text-dim); font-size: 0.9rem;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>

      <div class="queue-list" id="queueList">
        <!-- Queue items will appear here -->
      </div>
    </div>
  </section>

  <section class="character-tiers">
    <div class="tier-card">
      <span class="tier-stars">â­â­</span>
      <h3>Starter Tier</h3>
      <span class="tier-price">8<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</span></span>
      <p>Ø±ÙØ¹ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Starter')">Ø·Ù„Ø¨ Ù‡Ø°Ù‡
        Ø§Ù„ÙØ¦Ø©</button>
    </div>

    <div class="tier-card" style="border-color: var(--primary);">
      <span class="tier-stars">â­â­â­</span>
      <h3>Pro Tier</h3>
      <span class="tier-price">9<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</span></span>
      <p>ØªØ­Ø³ÙŠÙ† ÙƒØ¨ÙŠØ± Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ø®ØµÙŠØ©</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Pro')">Ø·Ù„Ø¨ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</button>
    </div>

    <div class="tier-card">
      <span class="tier-stars">â­â­â­â­</span>
      <h3>Ultimate Tier</h3>
      <span class="tier-price">10<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</span></span>
      <p>Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ù‚ÙˆØ©</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Ultimate')">Ø·Ù„Ø¨ Ù‡Ø°Ù‡
        Ø§Ù„ÙØ¦Ø©</button>
    </div>
  </section>

  <div style="text-align: center; margin-bottom: 100px;">
    <p class="note">
      ğŸ›¡ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¢Ù…Ù†Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙˆØªØªÙ… Ø¹Ø¨Ø± Ø®Ø¨Ø±Ø§Ø¡ Ù…ØªØ®ØµØµÙŠÙ†.
      <br>
      âš ï¸ Ø¥Ø®Ù„Ø§Ø¡ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©: Ù†Ø­Ù† Ø¬Ù‡Ø© Ø®Ø§Ø±Ø¬ÙŠØ© ÙˆÙ„Ø§ Ù†ØªØ¨Ø¹ Ø´Ø±ÙƒØ© Bandai Namco.
    </p>
  </div>

  <!-- Notification Modal -->
  <div id="notificationModal" class="notif-overlay">
    <div class="notif-card"
      style="max-width: 500px; width: 95%; min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
      <!-- Step 1: Announcement & Stars -->
      <div id="ratingStep1" class="rating-step">
        <h3 id="notifTitle">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡! ğŸš€</h3>
        <p id="notifMessage">Ù„Ù‚Ø¯ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§!</p>

        <div id="ratingContainer" class="hidden"
          style="border-top: 1px solid var(--glass-border); margin-top: 20px; padding-top: 20px;">
          <p style="text-align: center; margin-bottom: 5px; font-weight: bold; color: var(--primary);">Ù…Ø§ Ø±Ø£ÙŠÙƒ ÙÙŠ Ø¬ÙˆØ¯Ø©
            Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ â­</p>
          <div class="rating-stars" id="stars">
            <span class="star" data-value="1">â˜…</span>
            <span class="star" data-value="2">â˜…</span>
            <span class="star" data-value="3">â˜…</span>
            <span class="star" data-value="4">â˜…</span>
            <span class="star" data-value="5">â˜…</span>
          </div>
        </div>
      </div>

      <!-- Step 2: Comment -->
      <div id="ratingStep2" class="rating-step hidden">
        <h3 style="color: var(--primary);">ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø³Ù…Ø§Ø¹ Ø±Ø£ÙŠÙƒ! ğŸ’¬</h3>
        <p style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 15px;">Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙˆØ¯ Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ØŸ</p>
        <textarea id="reviewText" class="review-input" placeholder="Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù‡Ù†Ø§..." rows="3"></textarea>
        <button class="notif-btn" id="submitRatingBtn"
          style="width: 100%; height: 50px; font-weight: 800; background: var(--primary); color: #000;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
          Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
      </div>

      <!-- Step 3: Success -->
      <div id="ratingStep3" class="rating-step hidden" style="text-align: center;">
        <div class="success-check">âœ“</div>
        <h3 style="margin-bottom: 10px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! â¤ï¸</h3>
        <p style="color: var(--text-dim);">ØªÙ‚ÙŠÙŠÙ…Ùƒ ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ø®Ø¯Ù…Ø© Ø£ÙØ¶Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹.</p>
      </div>

      <div id="notifActions" style="display:flex; gap:10px; margin-top:20px;">
        <button class="notif-btn" id="viewHistoryBtn" onclick="location.href='history.html'">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="notif-btn" style="background: var(--glass); color: #fff;"
          onclick="closeNotification()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Character Selection Modal -->
  <div id="charModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 800px; width: 95%;">
      <h3>Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªÙ„ÙÙŠÙ„Ù‡Ø§ (<span id="modalStars"></span>) ğŸ—¡ï¸</h3>
      <div id="charGrid" class="char-grid">
        <!-- Characters will be injected here -->
      </div>
      <div class="modal-footer">
        <div class="price-display">
          <div class="price-label">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</div>
          <div id="totalPrice" class="price-total">0 Ø¬Ù†ÙŠÙ‡</div>
        </div>
        <div id="selectionActions" style="display:flex; gap:10px;">
          <button id="confirmSelection" class="notif-btn" style="width:auto; padding:12px 30px;">ØªØ£ÙƒÙŠØ¯ (0)</button>
          <button class="notif-btn" style="background: var(--glass); color: #fff; width:auto; padding:12px 20px;"
            onclick="closeCharModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Custom Confirm Modal -->
  <div id="confirmModal" class="confirm-overlay">
    <div class="confirm-card">
      <div id="confirmTitle" class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</div>
      <p id="confirmMsg" class="confirm-msg"></p>
      <div class="confirm-actions">
        <button id="confirmYes" class="confirm-btn yes">Ù†Ø¹Ù…ØŒ Ù…ØªØ£ÙƒØ¯</button>
        <button id="confirmNo" class="confirm-btn no">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <footer>
    <p><a href="index.html" style="color: var(--primary); text-decoration: none;">â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a></p>
  </footer>

  <script type="module">
    import { auth, onAuthStateChanged } from './firebase-config.js';
    import { login, logout, placeOrder, updateOrderStatus, listenToQueue, listenToUserOrders, listenToWorkers, getUserRole, submitRating, loadCharacters, getCharacters } from './app.js';

    const userInfo = document.getElementById('userInfo');
    const queueList = document.getElementById('queueList');
    const queueBrief = document.getElementById('queueBrief');
    const charGrid = document.getElementById('charGrid');
    const charModal = document.getElementById('charModal');
    const notificationModal = document.getElementById('notificationModal'); // Added for new notification modal logic

    let selectedTier = null;
    let selectedChars = new Set();
    const TIER_PRICES = { 'Starter': 8, 'Pro': 9, 'Ultimate': 10 };
    const TIER_STARS = { 'Starter': 2, 'Pro': 3, 'Ultimate': 4 };

    // Load characters on page load
    loadCharacters().then(() => {
      console.log('Characters loaded:', getCharacters().length);
    });

    window.orderNow = (tier) => {
      if (!auth.currentUser) {
        login();
        return;
      }
      selectedTier = tier;
      selectedChars.clear();
      openCharModal();
    };

    const openCharModal = () => {
      const CHARACTERS = getCharacters();
      const requiredStars = TIER_STARS[selectedTier];
      const filteredChars = CHARACTERS.filter(char => char.stars === requiredStars);

      document.getElementById('modalStars').innerText = `${requiredStars} Ù†Ø¬ÙˆÙ…`;

      if (filteredChars.length === 0) {
        charGrid.innerHTML = `
          <div style="grid-column: 1/-1; padding: 40px; text-align: center; color: var(--text-dim);">
            <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ”</div>
            <p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø®ØµÙŠØ§Øª ÙØ¦Ø© ${requiredStars} ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
          </div>
        `;
      } else {
        charGrid.innerHTML = filteredChars.map(char => `
          <div class="char-item" id="char-${char.id}" onclick="toggleChar('${char.id}')">
            <div style="width:80px; height:80px; border-radius:50%; border:2px solid var(--glass-border); background: linear-gradient(135deg, var(--primary), var(--accent)); display:flex; align-items:center; justify-content:center; margin:0 auto 10px;">
              <span style="font-size:1.5rem;">${char.stars === 5 ? 'ğŸŒŸ' : 'â­'.repeat(char.stars)}</span>
            </div>
            <div class="char-info">
              <div class="char-name">${char.name}</div>
              <div class="char-meta">${char.stars}â˜… | ${char.role}</div>
            </div>
          </div>
        `).join('');
      }
      updateSelectionUI();
      charModal.classList.add('visible');
    };

    window.closeCharModal = () => {
      charModal.classList.remove('visible');
    };

    window.toggleChar = (charId) => {
      if (selectedChars.has(charId)) {
        selectedChars.delete(charId);
        document.getElementById(`char-${charId}`).classList.remove('selected');
      } else {
        selectedChars.add(charId);
        document.getElementById(`char-${charId}`).classList.add('selected');
      }
      updateSelectionUI();
    };

    const updateSelectionUI = () => {
      const pricePerChar = TIER_PRICES[selectedTier] || 0;
      const total = pricePerChar * selectedChars.size;
      document.getElementById('totalPrice').innerText = `${total} Ø¬Ù†ÙŠÙ‡`;
      document.getElementById('confirmSelection').innerText = `ØªØ£ÙƒÙŠØ¯ (${selectedChars.size})`;
      document.getElementById('confirmSelection').disabled = selectedChars.size === 0;
      document.getElementById('confirmSelection').style.opacity = selectedChars.size === 0 ? '0.5' : '1';
    };

    document.getElementById('confirmSelection').onclick = () => {
      if (selectedChars.size === 0) {
        showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø®ØµÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!", "âš ï¸");
        return;
      }

      const CHARACTERS = getCharacters();
      const selectedData = Array.from(selectedChars).map(id => CHARACTERS.find(c => c.id === id));
      const names = selectedData.map(c => c.name).join('ØŒ ');

      showConfirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ù„Ø¨ Ø§Ù„ÙØ¦Ø© ${selectedTier} Ù„Ù€ ${selectedChars.size} Ø´Ø®ØµÙŠØ§Øª (${names})ØŸ Ø¨Ù‚ÙŠÙ…Ø© Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© ${TIER_PRICES[selectedTier] * selectedChars.size} Ø¬Ù†ÙŠÙ‡ØŸ`, async () => {
        closeCharModal();
        showToast("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...", "â³");

        await placeOrder(selectedTier, selectedData);
      });
    };


    // UI Helper Functions
    window.showToast = (message, icon = 'â„¹ï¸') => {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    };

    window.showConfirm = (message, onConfirm) => {
      const modal = document.getElementById('confirmModal');
      const msg = document.getElementById('confirmMsg');
      const yesBtn = document.getElementById('confirmYes');
      const noBtn = document.getElementById('confirmNo');

      msg.innerText = message;
      modal.classList.add('visible');

      const close = () => modal.classList.remove('visible');

      yesBtn.onclick = () => { onConfirm(); close(); };
      noBtn.onclick = close;
    };

    window.updateStatus = (id, status) => {
      showConfirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${status === 'working' ? 'Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„' : status === 'done' ? 'Ø¥Ù†Ù‡Ø§Ø¡' : 'Ø±ÙØ¶'}ØŸ`, () => {
        updateOrderStatus(id, status);
      });
    };

    // Ù†Ø­Ø¯Ø« Ø§Ù„ÙŠÙˆØ²Ø± ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© ØªØªØºÙŠØ± ÙÙŠÙ‡Ø§ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ Ø£Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    const refreshUserUI = () => {
      const user = auth.currentUser;
      if (user) {
        const userRole = getUserRole(user.email);
        const isStaff = !!userRole;
        const workerBadge = isStaff ? `<span class="worker-badge">${userRole === 'admin' ? 'Admin ğŸ‘‘' : 'Staff ğŸ›¡ï¸'}</span>` : '';
        const workersLink = isStaff
          ? '<a href="workers.html" class="dropdown-item">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>'
          : '';

        userInfo.innerHTML = `
                <div class="user-dropdown">
                    <div class="user-profile">
                        <img src="${user.photoURL}" class="user-avatar">
                        <span class="user-name">${user.displayName} ${workerBadge}</span>
                    </div>
                    <div class="dropdown-menu">
                        <a href="history.html" class="dropdown-item">ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                        ${workersLink}
                        <a href="#" class="dropdown-item" onclick="handleLogout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
                    </div>
                </div>
            `;
      } else {
        userInfo.innerHTML = `<button class="auth-btn" onclick="handleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„</button>`;
      }
    };

    // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù…Ø§Ù„
    listenToWorkers(() => {
      refreshUserUI();
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙØªÙˆØ­Ø©ØŒ Ù†Ø¹ÙŠØ¯ Ø¹Ø±Ø¶Ù‡Ø§ Ù„ØªØ¸Ù‡Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø¯Ù…Ù†
      if (lastOrders) renderQueue(lastOrders);
    });

    onAuthStateChanged(auth, (user) => {
      refreshUserUI();
      if (user) {
        startOrderListener(user.uid);
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù‡Ø§ Ù…Ù† localStorage
    const savedNotifs = localStorage.getItem('notifiedOrders');
    const notifiedOrders = new Set(savedNotifs ? JSON.parse(savedNotifs) : []);

    const startOrderListener = (uid) => {
      listenToUserOrders(uid, (orders) => {
        orders.forEach(order => {
          if ((order.status === 'done' || order.status === 'rejected') && !notifiedOrders.has(order.id)) {
            showNotification(order);
            notifiedOrders.add(order.id);
            // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ localStorage
            localStorage.setItem('notifiedOrders', JSON.stringify(Array.from(notifiedOrders)));
          }
        });
      });
    };

    let currentOrderIdForRating = null;
    let selectedRatingValue = 0;

    const showNotification = (order) => {
      const modal = document.getElementById('notificationModal');
      const msg = document.getElementById('notifMessage');
      const title = document.getElementById('notifTitle');

      currentOrderIdForRating = order.id;

      // Reset to step 1
      document.getElementById('ratingStep1').classList.remove('hidden');
      document.getElementById('ratingStep2').classList.add('hidden');
      document.getElementById('ratingStep3').classList.add('hidden');
      document.getElementById('notifActions').style.display = 'flex';

      if (order.status === 'done') {
        title.innerText = 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡! ğŸš€';
        msg.innerText = `Ù„Ù‚Ø¯ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ (${order.tier}) Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§!`;
        document.getElementById('ratingContainer').classList.remove('hidden');
        setupRating();
      } else {
        title.innerText = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨';
        msg.innerText = `Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ (${order.tier}). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.`;
        document.getElementById('ratingContainer').classList.add('hidden');
      }

      modal.classList.add('visible');
    };

    const setupRating = () => {
      const stars = document.querySelectorAll('.star');
      const step1 = document.getElementById('ratingStep1');
      const step2 = document.getElementById('ratingStep2');
      const step3 = document.getElementById('ratingStep3');
      const submitBtn = document.getElementById('submitRatingBtn');
      const actions = document.getElementById('notifActions');

      selectedRatingValue = 0;
      document.getElementById('reviewText').value = '';

      stars.forEach(star => {
        star.classList.remove('active');
        star.onclick = () => {
          selectedRatingValue = parseInt(star.dataset.value);
          stars.forEach((s, i) => {
            if (i < selectedRatingValue) s.classList.add('active');
            else s.classList.remove('active');
          });

          // Auto transition to step 2 after a small delay
          setTimeout(() => {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            actions.style.display = 'none';
          }, 600);
        };
      });

      submitBtn.onclick = async () => {
        if (selectedRatingValue === 0) return;
        submitBtn.disabled = true;
        submitBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

        const review = document.getElementById('reviewText').value;
        const success = await submitRating(currentOrderIdForRating, selectedRatingValue, review);

        if (success) {
          step2.classList.add('hidden');
          step3.classList.remove('hidden');
          setTimeout(() => {
            actions.style.display = 'flex';
          }, 1000);
        } else {
          showToast("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….", "âŒ");
          submitBtn.disabled = false;
          submitBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ";
        }
      };
    };

    window.closeNotification = () => {
      document.getElementById('notificationModal').classList.remove('visible');
    };


    window.handleLogin = login;
    window.handleLogout = logout;

    let lastOrders = null;
    function renderQueue(orders) {
      lastOrders = orders;
      queueList.innerHTML = '';
      if (orders.length === 0) {
        queueBrief.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹. ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„!";
        return;
      }

      const user = auth.currentUser;
      const myOrderIndex = orders.findIndex(o => o.uid === user?.uid);
      if (myOrderIndex !== -1) {
        queueBrief.innerText = myOrderIndex === 0 && orders[0].status === 'working'
          ? "Ø£Ù†Øª Ø§Ù„Ø£Ù† ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ†ÙÙŠØ°! ğŸš€"
          : `Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² #${myOrderIndex + 1}ØŒ ÙŠÙˆØ¬Ø¯ ${myOrderIndex} Ù‚Ø¨Ù„Ùƒ.`;
      } else {
        queueBrief.innerText = `ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ${orders.length} Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±.`;
      }

      orders.forEach((order, index) => {
        const isWorking = order.status === 'working';
        const item = document.createElement('div');
        item.className = `queue-item ${isWorking ? 'active' : ''} ${order.uid === user?.uid ? 'mine' : ''}`;

        let workerInfo = '';
        if (isWorking && order.workerAvatar) {
          workerInfo = `
                    <div style="display:flex; align-items:center; gap:5px; font-size:0.75rem; color:var(--primary);">
                         <span>Ø¨ÙˆØ§Ø³Ø·Ø©:</span>
                         <img src="${order.workerAvatar}" style="width:20px; height:20px; border-radius:50%; border:1px solid var(--primary)">
                         <span>${order.workerName.split(' ')[0]}</span>
                    </div>
                `;
        }

        const characters = order.characters || [{ name: order.charName, image: order.charImage }];
        const charTags = characters.map(c => `
          <div style="display:inline-flex; align-items:center; gap:5px; background:rgba(255,255,255,0.05); padding:2px 8px; border-radius:10px; font-size:0.8rem;">
            ${c.image ? `<img src="${c.image}" style="width:16px; height:16px; border-radius:50%">` : 'ğŸ—¡ï¸'}
            <span>${c.name}</span>
          </div>
        `).join(' ');

        item.innerHTML = `
                <div style="display:flex; flex-direction:column; flex:1">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <img src="${order.userAvatar}" style="width:30px; height:30px; border-radius:50%">
                        <strong>${order.userName.split(' ')[0]} - ${order.tier}</strong>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-right:40px;">
                        ${charTags}
                    </div>
                    ${workerInfo}
                </div>
                <span class="pos-tag" style="display:flex; flex-direction:column; align-items:flex-end;">
                    ${isWorking ? '<span style="font-size:0.8rem">ğŸ”¥ Ø¬Ø§Ø±Ù Ø§Ù„Ø¹Ù…Ù„</span>' : '#' + (index + 1)}
                </span>
            `;
        queueList.appendChild(item);
      });
    }

    listenToQueue(renderQueue);
  </script>
</body>

</html>