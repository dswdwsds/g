<!DOCTYPE html>
<html lang="ar">

<head>
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://www.gstatic.com; img-src 'self' data: https://*.discordapp.com https://*.discordapp.net https://*.googleusercontent.com https://lh3.googleusercontent.com https://via.placeholder.com https://ui-avatars.com https://*.ibb.co; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://discord.com https://*.discordapp.com https://www.gstatic.com https://api.imgbb.com; frame-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com;">
  <meta charset="UTF-8">
  <link rel="icon" href="https://ui-avatars.com/api/?name=BR&background=00f2fe&color=000">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="ุฎุฏูุฉ ุชุทููุฑ ุดุฎุตูุงุช ูุนุจุฉ Bounty Rush - ุงุฎุชุฑ ุงููุฆุฉ ุงูููุงุณุจุฉ ูุทูุฑ ุดุฎุตูุงุชู ุงูููุถูุฉ ุจุณุฑุนุฉ ูุฃูุงู ูุน TEAM GS.">
  <meta property="og:title" content="ุชุทููุฑ ุดุฎุตูุงุช Bounty Rush | TEAM GS">
  <meta property="og:description" content="ุฃุณุฑุน ุฎุฏูุฉ ูุชุทููุฑ ุดุฎุตูุงุช ุจุงููุชู ุฑุงุด ุจุฃุณุนุงุฑ ุชูุงูุณูุฉ.">

  <title>ุชุทููุฑ ุดุฎุตูุงุช Bounty Rush | TEAM GS</title>

  <!-- Optimized Font Loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+Arabic:wght@400;700;800&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    .rating-stars {
      display: flex;
      gap: 12px;
      justify-content: center;
      font-size: 2.8rem;
      margin: 15px 0;
      direction: ltr;
      /* Ensure star hover works left-to-right logic */
      user-select: none;
    }

    .star {
      cursor: pointer;
      color: rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
      display: inline-block;
    }

    /* Hover effect: make all previous stars yellow */
    .star:hover,
    .star:hover~.star {
      color: #ffd700 !important;
      transform: scale(1.2);
    }

    /* Fixed rating effect */
    .star.active {
      color: #ffd700 !important;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }

    /* Make sure stars don't flicker on hover */
    .rating-stars:hover .star {
      color: rgba(255, 255, 255, 0.1);
    }

    .rating-stars:hover .star:hover,
    .rating-stars:hover .star:hover~.star {
      color: #ffd700 !important;
    }

    .review-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 15px;
      color: white;
      padding: 15px;
      margin-bottom: 20px;
      font-family: var(--font-ar);
      resize: none;
    }
  </style>
</head>

<body>

  <div id="navbar-placeholder"></div>

  <header class="hero" style="padding-top: 120px;">
    <h1>One Piece Bounty Rush</h1>
    <p>ููุฏู ุฎุฏูุฉ ุฑูุน ูุณุชูู ุงูุดุฎุตูุงุช ุจุณุฑุนุฉ ูุงุฆูุฉ ูุถูุงู ูุงูู ุถุฏ ุฃู ุฎูู.</p>
  </header>

  <section class="queue-container" id="queueDashboard" class="hidden">
    <div class="queue-card">
      <span class="queue-status-tag">Live Queue ๐ด</span>
      <h2 style="margin-bottom: 5px;">ุทุงุจูุฑ ุงูุงูุชุธุงุฑ ุงููุจุงุดุฑ</h2>
      <p id="queueBrief" style="color: var(--text-dim); font-size: 0.9rem;">ุจุงูุชุธุงุฑ ุฌูุจ ุงูุจูุงูุงุช...</p>

      <div class="queue-list" id="queueList">
        <!-- Queue items will appear here -->
      </div>
    </div>
  </section>

  <section class="character-tiers">
    <div style="width: 100%; text-align: center; margin-bottom: 30px;">
      <h2 style="font-size: 2.2rem; margin-bottom: 10px; color: #fff;">ุงุฎุชุฑ ูุณุงุฑู ูุญู ุงูููุฉ ๐ดโโ๏ธ</h2>
      <p style="color: var(--text-dim); font-size: 1.1rem;">ุจุงูุงุช ุงุญุชุฑุงููุฉ ูุตููุฉ ูุชููุญู ุงูุฃูุถููุฉ ุงูุณุงุญูุฉ ูู ุงููุนุฑูุฉ</p>
    </div>

    <div class="tier-card">
      <span class="tier-stars">โญโญ</span>
      <h3>Starter Tier</h3>
      <span class="tier-price">8<span class="tier-currency"> ุฌููู ูุตุฑู</span></span>
      <p>ุงูุทูุงูุฉ ูููุฉ ูุชุญุณูู ูุณุชูุงู ุงูุฃุณุงุณู</p>
      <div style="margin-top: 15px; background: rgba(0, 255, 157, 0.1); border-radius: 8px; padding: 8px;">
        <p style="font-size: 0.75rem; color: #00ff9d; margin: 0;">๐ก๏ธ <strong>ุถูุงู ุงูููุณู:</strong> ุญูุงูุฉ ูุงููุฉ ููุชุตููู
          + ุชุนููุถ ูุฌุงูู</p>
      </div>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Starter')">ุทูุจ ูุฐู
        ุงููุฆุฉ</button>
      <div class="offer-ribbon">ุนุฑุถ ุงูุงูุชุชุงุญ</div>
    </div>

    <div class="tier-card" style="border-color: var(--primary);">
      <span class="tier-stars">โญโญโญ</span>
      <h3>Pro Tier</h3>
      <span class="tier-price">9<span class="tier-currency"> ุฌููู ูุตุฑู</span></span>
      <p>ุชูุงุฒู ูุซุงูู ุจูู ุงูุณุฑุนุฉ ูุงูููุฉ</p>
      <div style="margin-top: 15px; background: rgba(0, 255, 157, 0.1); border-radius: 8px; padding: 8px;">
        <p style="font-size: 0.75rem; color: #00ff9d; margin: 0;">๐ก๏ธ <strong>ุถูุงู ุงูููุณู:</strong> ุญูุงูุฉ ูุงููุฉ ููุชุตููู
          + ุชุนููุถ ูุฌุงูู</p>
      </div>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Pro')">ุทูุจ ูุฐู ุงููุฆุฉ</button>
      <div class="offer-ribbon">ุนุฑุถ ุงูุงูุชุชุงุญ</div>
    </div>

    <div class="tier-card">
      <span class="tier-stars">โญโญโญโญ</span>
      <h3>Ultimate Tier</h3>
      <span class="tier-price">10<span class="tier-currency"> ุฌููู ูุตุฑู</span></span>
      <p>ุงูุณูุทุฑุฉ ุงููุทููุฉ ูุชุฏููุฑ ุงูุฎุตูู</p>
      <div style="margin-top: 15px; background: rgba(0, 255, 157, 0.1); border-radius: 8px; padding: 8px;">
        <p style="font-size: 0.75rem; color: #00ff9d; margin: 0;">๐ก๏ธ <strong>ุถูุงู ุงูููุณู:</strong> ุญูุงูุฉ ูุงููุฉ ููุชุตููู
          + ุชุนููุถ ูุฌุงูู</p>
      </div>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Ultimate')">ุทูุจ ูุฐู
        ุงููุฆุฉ</button>
      <div class="offer-ribbon">ุนุฑุถ ุงูุงูุชุชุงุญ</div>
    </div>
  </section>

  <!-- Special Bulk Offers -->
  <section class="character-tiers" style="margin-top: 50px;">
    <div class="tier-card" style="border-color: #00f2fe; background: rgba(0, 242, 254, 0.05);">
      <span class="tier-stars">โญโญ / โญโญโญ</span>
      <h3>ุจุงูุฉ ุงูุชูููุฑ</h3>
      <span class="tier-price">100<span class="tier-currency"> ุฌููู</span></span>
      <p>20 ุดุฎุตูุฉ (ูููุณ ูุฌูุชูู ูุซูุงุซ)</p>
      <p style="font-size:0.8rem; color:#ff4d4d; margin-top:5px;">*ูุฑุฉ ูุงุญุฏุฉ ููู ุญุณุงุจ</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%; background: #00f2fe; color:#000;"
        onclick="orderNow('BulkMix', event)">ุทูุจ ุงูุจุงูุฉ</button>
      <div class="offer-ribbon new">ุนุฑุถ ุฎุงุต</div>
    </div>

    <div class="tier-card" style="border-color: #ff00c8; background: rgba(255, 0, 200, 0.05);">
      <span class="tier-stars">โญโญโญโญ</span>
      <h3>ุจุงูุฉ ุงูููุฉ</h3>
      <span class="tier-price">140<span class="tier-currency"> ุฌููู</span></span>
      <p>20 ุดุฎุตูุฉ (ุฃุฑุจุน ูุฌูู)</p>
      <p style="font-size:0.8rem; color:#ff4d4d; margin-top:5px;">*ูุฑุฉ ูุงุญุฏุฉ ููู ุญุณุงุจ</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%; background: #ff00c8;"
        onclick="orderNow('BulkUltimate', event)">ุทูุจ ุงูุจุงูุฉ</button>
      <div class="offer-ribbon new">ุนุฑุถ ุฎุงุต</div>
    </div>
  </section>

  <section class="character-tiers" style="display:none;">
    <!-- Hidden original closing tag area placeholder if needed layout adjustment -->
  </section>

  <div style="text-align: center; margin-bottom: 100px;">
    <p class="note">
      ๐ก๏ธ ุงูุนูููุฉ ุขููุฉ ุชูุงูุงู ูุชุชู ุนุจุฑ ุฎุจุฑุงุก ูุชุฎุตุตูู.
      <br>
      โ๏ธ ุฅุฎูุงุก ูุณุคูููุฉ: ูุญู ุฌูุฉ ุฎุงุฑุฌูุฉ ููุง ูุชุจุน ุดุฑูุฉ Bandai Namco.
    </p>
  </div>

  <!-- Notification Modal -->
  <div id="notificationModal" class="notif-overlay">
    <div class="notif-card"
      style="max-width: 500px; width: 95%; min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
      <!-- Step 1: Announcement & Stars -->
      <div id="ratingStep1" class="rating-step">
        <h3 id="notifTitle">ุชู ุงูุงูุชูุงุก! ๐</h3>
        <p id="notifMessage">ููุฏ ุชู ุฅููุงู ุทูุจู ุจูุฌุงุญ. ุดูุฑุงู ูุซูุชู ุจูุง!</p>

        <div id="ratingContainer" class="hidden"
          style="border-top: 1px solid var(--glass-border); margin-top: 20px; padding-top: 20px;">
          <p style="text-align: center; margin-bottom: 5px; font-weight: bold; color: var(--primary);">ูุง ุฑุฃูู ูู ุฌูุฏุฉ
            ุงูุฎุฏูุฉุ โญ</p>
          <div class="rating-stars" id="stars" style="flex-direction: row-reverse;">
            <span class="star" data-value="5">โ</span>
            <span class="star" data-value="4">โ</span>
            <span class="star" data-value="3">โ</span>
            <span class="star" data-value="2">โ</span>
            <span class="star" data-value="1">โ</span>
          </div>
        </div>
      </div>

      <!-- Step 2: Comment -->
      <div id="ratingStep2" class="rating-step hidden">
        <h3 style="color: var(--primary);">ูุณุนุฏูุง ุณูุงุน ุฑุฃูู! ๐ฌ</h3>
        <p style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 15px;">ูู ูุฏูู ุฃู ููุงุญุธุงุช ุชูุฏ ูุดุงุฑูุชูุงุ</p>
        <textarea id="reviewText" class="review-input" placeholder="ุงูุชุจ ุชููููู ููุง..." rows="3"></textarea>
        <button class="notif-btn" id="submitRatingBtn"
          style="width: 100%; height: 50px; font-weight: 800; background: var(--primary); color: #000;">ุฅุฑุณุงู ุงูุชูููู
          ุงูููุงุฆู</button>
      </div>

      <!-- Step 3: Success -->
      <div id="ratingStep3" class="rating-step hidden" style="text-align: center;">
        <div class="success-check">โ</div>
        <h3 style="margin-bottom: 10px;">ุดูุฑุงู ูู! โค๏ธ</h3>
        <p style="color: var(--text-dim);">ุชููููู ูุณุงุนุฏูุง ุนูู ุชูุฏูู ุฎุฏูุฉ ุฃูุถู ุฏุงุฆูุงู.</p>
      </div>

      <div id="notifActions" style="display:flex; gap:10px; margin-top:20px;">
        <button class="notif-btn" id="viewHistoryBtn" onclick="location.href='history.html'">ุณุฌู ุงูุทูุจุงุช</button>
        <button class="notif-btn" style="background: var(--glass); color: #fff;"
          onclick="closeNotification()">ุฅุบูุงู</button>
      </div>
    </div>
  </div>

  <!-- Character Selection Modal -->
  <div id="charModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 850px; width: 95%; padding: 25px;">
      <!-- Header -->
      <div style="border-bottom: 2px solid var(--glass-border); padding-bottom: 15px; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 1.3rem;">ุงุฎุชุฑ ุงูุดุฎุตูุงุช (<span id="modalStars"></span>) ๐ก๏ธ</h3>
      </div>

      <!-- Filters -->
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="charSearch" placeholder="ุจุญุซ ุจุงุณู ุงูุดุฎุตูุฉ..." class="review-input"
          style="margin-bottom: 0; flex: 2; background: rgba(0,0,0,0.3);">
        <select id="roleFilter" class="review-input"
          style="margin-bottom: 0; flex: 1; background: rgba(0,0,0,0.3); padding-left: 5px;">
          <option value="">ูู ุงูุฃุฏูุงุฑ</option>
          <option value="ููุงุฌู">ููุงุฌู</option>
          <option value="ูุฏุงูุน">ูุฏุงูุน</option>
          <option value="ุนุฏุงุก">ุนุฏุงุก</option>
        </select>
        <select id="elementFilter" class="review-input"
          style="margin-bottom: 0; flex: 1; background: rgba(0,0,0,0.3); padding-left: 5px;">
          <option value="">ูู ุงูุนูุงุตุฑ</option>
          <option value="ุฃุญูุฑ">ุฃุญูุฑ</option>
          <option value="ุฃุฎุถุฑ">ุฃุฎุถุฑ</option>
          <option value="ุฃุฒุฑู">ุฃุฒุฑู</option>
        </select>
      </div>

      <!-- Character Grid -->
      <div id="charGrid" class="char-grid"
        style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 10px;">
        <!-- Characters will be injected here -->
      </div>

      <!-- Info Section -->
      <div
        style="background: rgba(255, 235, 59, 0.08); border: 1px solid rgba(255, 235, 59, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: right;">
        <div style="font-size: 0.85rem; color: #fff; line-height: 1.6;">
          <div style="margin-bottom: 8px;">
            โ๏ธ <strong style="color: #ffeb3b;">ุชูุจูู:</strong> ุงูุฎุฏูุฉ ูุชุงุญุฉ ูููุตุฉ <strong>Steam</strong> ููุท
          </div>
          <div>
            ๐ก๏ธ <strong style="color: #00f2fe;">ุถูุงู ุงูููุณู:</strong> ูุถูู ุงูุญูุงุธ ุนูู ุงูุชุตููู ุทูุงู ุงูููุณู + ุฏุฎูู ูุฌุงูู
            ุนูุฏ ุงููุฒูู
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer" style="border-top: 2px solid var(--glass-border); padding-top: 15px;">
        <div class="price-display" style="margin-bottom: 15px;">
          <div class="price-label" style="font-size: 0.9rem; color: var(--text-dim);">ุงูุณุนุฑ ุงูุฅุฌูุงูู:</div>
          <div id="totalPrice" class="price-total" style="font-size: 1.8rem; font-weight: bold;">0 ุฌููู</div>
        </div>

        <div id="selectionActions" style="display:flex; gap:10px; justify-content: center;">
          <button id="confirmSelection" class="notif-btn"
            style="flex: 1; max-width: 200px; padding: 14px 25px; font-size: 1.05rem;">ุชุฃููุฏ (0)</button>
          <button class="notif-btn"
            style="flex: 1; max-width: 150px; background: var(--glass); color: #fff; padding: 14px 20px;"
            onclick="closeCharModal()">ุฅูุบุงุก</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Steam Login Modal -->
  <div id="steamModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 500px; width: 95%;">
      <h3 style="margin-bottom: 20px;">๐ ุจูุงูุงุช ุญุณุงุจ Steam</h3>

      <div
        style="background: rgba(255, 235, 59, 0.08); border: 1px solid rgba(255, 235, 59, 0.3); border-radius: 12px; padding: 12px; margin-bottom: 20px; text-align: right; font-size: 0.85rem;">
        โ๏ธ ูุญุชุงุฌ ููุฏุฎูู ุฅูู ุญุณุงุจู ูุฅุชูุงู ุงูุชูููู. ุจูุงูุงุชู ูุญููุฉ ุจุงููุงูู ููู ุชูุณุชุฎุฏู ูุฃู ุบุฑุถ ุขุฎุฑ.
      </div>

      <div style="text-align: right; margin-bottom: 20px;">
        <p style="margin-bottom: 12px; font-weight: bold; color: var(--primary);">ุงุฎุชุฑ ุทุฑููุฉ ุงูุฏุฎูู:</p>

        <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="loginMethod" value="credentials" checked onchange="toggleLoginInputs()">
            <span>ุญุณุงุจ Steam (ุงุณู + ุจุงุณูุฑุฏ)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="loginMethod" value="qr" onchange="toggleLoginInputs()">
            <span>QR Code (ุชูุงุตู ุฏุนู)</span>
          </label>
        </div>

        <form onsubmit="event.preventDefault(); document.getElementById('confirmSteamLogin').click();">
          <div id="steamInputs" style="display: block;">
            <input type="text" id="steamUsername" placeholder="ุงุณู ุงููุณุชุฎุฏู (Steam Username)" class="review-input"
              autocomplete="username"
              style="margin-bottom: 10px; width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 8px;">
            <input type="password" id="steamPassword" placeholder="ูููุฉ ุงููุฑูุฑ (Password)" class="review-input"
              autocomplete="current-password"
              style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 8px;">
          </div>
        </form>

        <!-- QR Code Info -->
        <div id="qrInfo"
          style="display: none; background: rgba(0, 242, 254, 0.08); border: 1px solid var(--primary); border-radius: 12px; padding: 15px; text-align: right; line-height: 1.8;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: var(--primary);">๐ฑ ุทุฑููุฉ QR Code:</p>
          <p style="margin: 0 0 8px 0; font-size: 0.9rem;">
            โ ุจุนุฏ ูุจูู ุทูุจู ููุตูู ุฏูุฑูุ ุฃุญุฏ ุฃุนุถุงุก ุงูุฏุนู ุณูุชูุงุตู ูุนู ุนุจุฑ Discord ูุฅุฑุณุงู QR Code.
          </p>
          <p style="margin: 0 0 12px 0; font-size: 0.85rem; color: #ffeb3b;">
            โก <strong>ููุฃุณุฑุน:</strong> ุฅุฐุง ุฃุฏุฎูุช ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑุ ุณูุจุฏุฃ ุงูุนูู ุนูู ุทูุจู ููุฑุงู ุจุฏูู ุงูุชุธุงุฑ!
            (ููููู ูุชุงุจุนุฉ ุงูุทูุจ ุนุจุฑ ุฏุฑุฏุดุฉ ุงููููุน ุงูุฏุงุฎููุฉ ุฃูุถุงู)
          </p>
          <a href="https://discord.com/channels/1284591581717987422/1284591582187622539" target="_blank"
            style="display: inline-flex; align-items: center; gap: 6px; background: #5865F2; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9rem;">
            <span>Discord</span> ๐ฌ
          </a>
        </div>
      </div>

      <div style="display: flex; gap: 10px;">
        <button id="confirmSteamLogin" class="notif-btn" style="flex: 1; padding: 14px;">ูุชุงุจุนุฉ ููุฏูุน</button>
        <button class="notif-btn" style="flex: 1; background: var(--glass); color: #fff; padding: 14px;"
          onclick="closeSteamModal()">ุฅูุบุงุก</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 500px; width: 95%;">
      <h3>ุฅุชูุงู ุนูููุฉ ุงูุฏูุน ๐ธ</h3>
      <p style="text-align: center; color: var(--text-dim); margin-bottom: 20px;">ูุฑุฌู ุชุญููู ุงููุจูุบ ุงููุทููุจ ูููุชุงุจุนุฉ.
      </p>

      <div class="payment-info-box">
        <div class="price-row">
          <span>ุงููุจูุบ ุงููุณุชุญู:</span>
          <strong id="payAmount" style="color: var(--primary); font-size: 1.5rem;">0 ุฌููู</strong>
        </div>
        <div class="wallet-row">
          <span>ุฑูู ุงููุญูุธุฉ (Vodafone Cash):</span>
          <div class="copy-box" onclick="copyWalletNumber()">
            <strong id="payWallet">01015831676</strong>
            <span style="font-size: 0.8rem; opacity: 0.7;">๐ ูุณุฎ</span>
          </div>
        </div>
      </div>

      <div class="upload-section">
        <div style="margin-bottom: 20px;">
          <p style="font-size: 0.9rem; margin-bottom: 10px;">ุฑูู ุงููุญูุธุฉ ุงูุฐู ููุช ุจุงูุชุญููู ููู:</p>
          <input type="text" id="senderWalletInput" placeholder="ุฑูู ุงููุญูู (ูุซุงู: 010...)"
            style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: white; outline: none;">
        </div>
        <p style="font-size: 0.9rem; margin-bottom: 10px;">ูู ุจุฑูุน ุตูุฑุฉ ุฅูุตุงู ุงูุฏูุน (Screenshot):</p>
        <label class="custom-upload">
          <input type="file" id="receiptInput" accept="image/*" hidden>
          <div class="upload-placeholder" id="uploadPlaceholder">
            <span style="font-size: 2rem;">๐ธ</span>
            <p id="fileNameDisplay">ุงุถุบุท ูุฑูุน ุงูุตูุฑุฉ</p>
          </div>
        </label>
      </div>

      <div class="modal-footer" style="padding: 0; margin-top: 25px; border: none;">
        <button id="submitPayment" class="auth-btn" style="width: 100%; height: 50px;">ุฅุฑุณุงู ุงูุฅูุตุงู ูุชุฃููุฏ
          ุงูุทูุจ</button>
        <button class="notif-btn"
          style="background: transparent; color: var(--text-dim); width: 100%; margin-top: 10px; border: none;"
          onclick="closePaymentModal()">ุฅุบูุงู (ุณุฃุฏูุน ูุงุญูุงู)</button>
      </div>
    </div>
  </div>

  <div id="shared-modals-placeholder"></div>

  <!-- Floating Support Button -->
  <a href="https://discord.com/channels/1284591581717987422/1284591582187622539" target="_blank"
    class="floating-support-btn">
    <span>๐ง</span>
    <span>ุชุญุฏุซ ูุน ุงูุฏุนู</span>
  </a>

  <!-- Character Lightbox Modal -->
  <div id="charLightbox" class="notif-overlay" onclick="closeCharLightbox()">
    <div class="notif-card"
      style="max-width: 400px; text-align: center; background: rgba(0,0,0,0.8); border: 2px solid var(--primary); padding: 10px;"
      onclick="event.stopPropagation()">
      <img id="lightboxImg" src=""
        style="width: 100%; border-radius: 15px; margin-bottom: 10px; box-shadow: 0 0 20px var(--primary);">
      <div id="lightboxName" style="font-weight: 800; font-size: 1.2rem; color: #fff; margin-bottom: 15px;"></div>
      <button class="notif-btn" style="width: 100%;" onclick="closeCharLightbox()">ุฅุบูุงู</button>
    </div>
  </div>

  <script type="module">
    import { auth, onAuthStateChanged, db, doc, getDoc } from './firebase-config.js';
    import {
      login, logout, placeOrder, sendPaymentProofToDiscord, updateOrderStatus,
      listenToQueue, listenToUserOrders, listenToWorkers, getUserRole,
      submitRating, loadCharacters, getCharacters, listenToUnreadCount, hasUserPurchasedOffer,
      showToast, showConfirm, openChat
    } from './app.js';
    import { initSharedUI } from './ui.js';

    // Initialize Shared UI Components (Navbar, Modals, Auth)
    initSharedUI();

    const userInfo = document.getElementById('userInfo');
    const queueList = document.getElementById('queueList');
    const queueBrief = document.getElementById('queueBrief');
    const charGrid = document.getElementById('charGrid');
    const charModal = document.getElementById('charModal');
    const notificationModal = document.getElementById('notificationModal'); // Added for new notification modal logic

    let selectedTier = null;
    let selectedChars = new Set();

    // Base Prices
    const TIER_PRICES = { 'Starter': 8, 'Pro': 9, 'Ultimate': 10 };
    // Offer Prices (5-10 chars)
    const OFFER_PRICES = { 'Starter': 6, 'Pro': 7, 'Ultimate': 8 };

    const TIER_STARS = {
      'Starter': 2,
      'Pro': 3,
      'Ultimate': 4,
      'BulkMix': [2, 3], // Mix of 2 and 3 stars
      'BulkUltimate': 4
    };

    // Load characters on page load
    loadCharacters().then(() => {
      console.log('Characters loaded:', getCharacters().length);
    });

    // Toggle Login Inputs (Steam vs QR)
    window.toggleLoginInputs = () => {
      const method = document.querySelector('input[name="loginMethod"]:checked').value;
      const steamInputs = document.getElementById('steamInputs');
      const qrInfo = document.getElementById('qrInfo');

      if (method === 'credentials') {
        steamInputs.style.display = 'block';
        qrInfo.style.display = 'none';
      } else {
        steamInputs.style.display = 'none';
        qrInfo.style.display = 'block';
      }
    };

    window.orderNow = async (tier, event) => {
      if (!auth.currentUser) {
        login();
        return;
      }

      // Check for one-time offer eligibility
      if (tier.startsWith('Bulk')) {
        const btn = event.target; // Capture button to maybe show loader?
        const originalText = btn.innerText;
        btn.innerText = "ุฌุงุฑู ุงูุชุญูู...";
        btn.disabled = true;

        const hasPurchased = await hasUserPurchasedOffer(auth.currentUser.uid, tier);

        btn.innerText = originalText;
        btn.disabled = false;

        if (hasPurchased) {
          if (window.showToast) window.showToast("ุนุฐุฑุงูุ ูุฐุง ุงูุนุฑุถ ูุชุงุญ ูุฑุฉ ูุงุญุฏุฉ ููุท ููู ุญุณุงุจ! ๐ซ", "โ");
          else alert("ุนุฐุฑุงูุ ูุฐุง ุงูุนุฑุถ ูุชุงุญ ูุฑุฉ ูุงุญุฏุฉ ููุท ููู ุญุณุงุจ! ๐ซ");
          return;
        }
      }

      selectedTier = tier;
      selectedChars.clear();

      openCharModal();
      openCharModal();
    };

    // Filter Logic
    const filterCharacters = () => {
      const CHARACTERS = getCharacters();
      const starsCriteria = TIER_STARS[selectedTier];
      const searchText = document.getElementById('charSearch').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const elementFilter = document.getElementById('elementFilter').value;

      // 1. Filter by Tier (Stars)
      let filtered = [];
      if (Array.isArray(starsCriteria)) {
        filtered = CHARACTERS.filter(char => starsCriteria.includes(char.stars));
      } else {
        filtered = CHARACTERS.filter(char => char.stars === starsCriteria);
      }

      // 2. Filter by Name
      if (searchText) {
        filtered = filtered.filter(char => char.name.toLowerCase().includes(searchText));
      }

      // 3. Filter by Role
      if (roleFilter) {
        filtered = filtered.filter(char => char.role === roleFilter);
      }

      // 4. Filter by Element
      if (elementFilter) {
        filtered = filtered.filter(char => char.element === elementFilter);
      }

      currentFilteredChars = filtered;

      // Update Title Count if needed or just reset grid
      // document.getElementById('modalStars') ... (remains static or update count?)

      // Reset Pagination and Render
      currentRenderCount = 0;
      charGrid.innerHTML = '';
      renderNextBatch();
    };

    // Attach Filter Listeners
    document.getElementById('charSearch').addEventListener('input', filterCharacters);
    document.getElementById('roleFilter').addEventListener('change', filterCharacters);
    document.getElementById('elementFilter').addEventListener('change', filterCharacters);

    // Pagination State
    let currentFilteredChars = [];
    let currentRenderCount = 0;
    const BATCH_SIZE = 20;

    const openCharModal = () => {
      const CHARACTERS = getCharacters();
      const starsCriteria = TIER_STARS[selectedTier];

      // Filter Logic handling Array (for mix) or Number
      let titleChars = "";

      if (Array.isArray(starsCriteria)) {
        // currentFilteredChars set initially by filterCharacters
        titleChars = starsCriteria.map(s => s + ' ูุฌูู').join(' ู ');
      } else {
        titleChars = starsCriteria + ' ูุฌูู';
      }

      document.getElementById('modalStars').innerText = titleChars;

      // Reset Inputs
      document.getElementById('charSearch').value = "";
      document.getElementById('roleFilter').value = "";
      document.getElementById('elementFilter').value = "";

      // Trigger Initial Filter (which renders the grid)
      filterCharacters();

      // Inject Offer Banner if applicable
      const offerBanner = document.getElementById('offerBanner');
      if (offerBanner) offerBanner.remove(); // Clean up old one

      if (!selectedTier.startsWith('Bulk')) {
        const discountPrice = OFFER_PRICES[selectedTier];
        const banner = document.createElement('div');
        banner.id = 'offerBanner';
        banner.style.cssText = "background: rgba(0, 242, 254, 0.1); border: 1px dashed var(--primary); color: var(--text); padding: 10px; margin-bottom: 15px; border-radius: 8px; text-align: center; font-size: 0.9rem;";
        banner.innerHTML = `๐ฅ <strong>ุนุฑุถ ุฎุงุต:</strong> ุงุฎุชุฑ ุจูู 5 ู 10 ุดุฎุตูุงุช ููุตุจุญ ุงูุณุนุฑ <span style="color:#00f2fe; font-weight:bold;">${discountPrice} ุฌููู</span> ููุดุฎุตูุฉ!`;
        charGrid.parentElement.insertBefore(banner, charGrid);
      }

      // Reset Pagination
      currentRenderCount = 0;
      charGrid.innerHTML = '';

      // Initial Render handled by filterCharacters -> renderNextBatch
      // renderNextBatch();

      updateSelectionUI();
      charModal.classList.add('visible');
    };

    const renderNextBatch = () => {
      const start = currentRenderCount;
      const end = Math.min(start + BATCH_SIZE, currentFilteredChars.length);
      const batch = currentFilteredChars.slice(start, end);

      if (batch.length === 0 && start === 0) {
        charGrid.innerHTML = `
              <div style="grid-column: 1/-1; padding: 40px; text-align: center; color: var(--text-dim);">
                <div style="font-size: 3rem; margin-bottom: 20px;">๐</div>
                <p>ุนุฐุฑุงูุ ูุง ููุฌุฏ ุดุฎุตูุงุช ูุทุงุจูุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุญุงููุงู.</p>
              </div>
            `;
        return;
      }

      const batchHTML = batch.map(char => {
        const imageHtml = char.image
          ? `<img src="${char.image}" style="width:100%; height:100%; border-radius:50%; object-fit:cover;" loading="lazy">`
          : `<span style="font-size:1.5rem;">${char.stars === 5 ? '๐' : 'โญ'.repeat(char.stars)}</span>`;

        return `
          <div class="char-item ${selectedChars.has(char.id) ? 'selected' : ''}" id="char-${char.id}" onclick="toggleChar('${char.id}')">
            <div style="width:110px; height:110px; border-radius:50%; border:2px solid var(--glass-border); background: linear-gradient(135deg, var(--primary), var(--accent)); display:flex; align-items:center; justify-content:center; margin:0 auto 10px; overflow:hidden;">
              ${imageHtml}
            </div>
            <div class="char-info">
              <div class="char-name">${char.name}</div>
              <div class="char-meta">${char.stars}โ | ${char.role}</div>
            </div>
            <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.6); padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; pointer-events: none;">
                ${selectedChars.has(char.id) ? 'โ' : 'โ'}
            </div>
          </div>
        `;
      }).join('');

      // Append to grid using insertAdjacentHTML to keep existing event listeners intact if any (though here we use onclick attribute)
      charGrid.insertAdjacentHTML('beforeend', batchHTML);
      currentRenderCount = end;

      // Manage Load More Button
      manageLoadMoreButton();
    };

    const manageLoadMoreButton = () => {
      let loadMoreBtn = document.getElementById('loadMoreBtn');
      if (currentRenderCount < currentFilteredChars.length) {
        if (!loadMoreBtn) {
          loadMoreBtn = document.createElement('button');
          loadMoreBtn.id = 'loadMoreBtn';
          loadMoreBtn.innerText = 'ุนุฑุถ ุงููุฒูุฏ โฌ๏ธ';
          loadMoreBtn.className = 'auth-btn';
          loadMoreBtn.style.cssText = "grid-column: 1/-1; margin: 10px auto; width: fit-content; min-width: 200px;";
          loadMoreBtn.onclick = renderNextBatch;
        }

        loadMoreBtn.style.display = 'block';
        charGrid.appendChild(loadMoreBtn); // Append (or move) to the end of the grid
      } else {
        if (loadMoreBtn) loadMoreBtn.remove();
      }
    };

    window.closeCharModal = () => {
      charModal.classList.remove('visible');
    };

    window.toggleChar = (charId) => {
      // Bulk Limit Check
      if (selectedTier.startsWith('Bulk') && !selectedChars.has(charId) && selectedChars.size >= 20) {
        alert("ููููู ุงุฎุชูุงุฑ 20 ุดุฎุตูุฉ ููุท ูู ูุฐุง ุงูุนุฑุถ!");
        return;
      }

      if (selectedChars.has(charId)) {
        selectedChars.delete(charId);
        document.getElementById(`char-${charId}`).classList.remove('selected');
      } else {
        selectedChars.add(charId);
        document.getElementById(`char-${charId}`).classList.add('selected');
      }
      updateSelectionUI();
    };

    const updateSelectionUI = () => {
      let total = 0;
      let count = selectedChars.size;
      let isValid = true;
      let statusMsg = "";
      let offerProgressMsg = "";

      if (selectedTier === 'BulkMix') {
        total = 100;
        if (count !== 20) {
          isValid = false;
          statusMsg = ` (ูุฌุจ ุงุฎุชูุงุฑ 20 ุดุฎุตูุฉ - ุงุฎุชุฑุช ${count})`;
        }
      }
      else if (selectedTier === 'BulkUltimate') {
        total = 140;
        if (count !== 20) {
          isValid = false;
          statusMsg = ` (ูุฌุจ ุงุฎุชูุงุฑ 20 ุดุฎุตูุฉ - ุงุฎุชุฑุช ${count})`;
        }
      }
      else {
        // Dynamic Pricing for Standard Tiers (Opening Offer)
        const isOffer = count >= 5 && count <= 10;
        const price = isOffer ? OFFER_PRICES[selectedTier] : TIER_PRICES[selectedTier];
        total = price * count;

        if (isOffer) {
          statusMsg = ` <br><span style="color:#00f2fe; font-size:0.8rem;">๐ฅ ุงูุนุฑุถ ููุนู! (ุงูุณุนุฑ ${price}ุฌ ุจุฏูุงู ูู ${TIER_PRICES[selectedTier]}ุฌ)</span>`;
        } else if (count > 0 && count < 5) {
          const needed = 5 - count;
          offerProgressMsg = `<div style="margin-top:5px; color: var(--accent); font-size:0.8rem;">๐ก ุงุฎุชุฑ <strong>${needed}</strong> ุดุฎุตูุงุช ุฅุถุงููุฉ ูุชูุนูู ุงูุนุฑุถ ุงูุฎุงุต!</div>`;
        }

        if (count === 0) isValid = false;
      }

      const totalElement = document.getElementById('totalPrice');
      totalElement.innerHTML = `${total} ุฌููู${statusMsg} ${offerProgressMsg}`; // Use innerHTML for formatting

      const btn = document.getElementById('confirmSelection');
      btn.innerText = `ุชุฃููุฏ (${count})${isValid ? '' : ' โ'}`;
      btn.disabled = !isValid;
      btn.style.opacity = !isValid ? '0.5' : '1';
    };

    // Store order info temporarily
    let pendingOrderData = null;

    document.getElementById('confirmSelection').onclick = () => {
      if (selectedChars.size === 0) {
        showToast("ูุฑุฌู ุงุฎุชูุงุฑ ุดุฎุตูุฉ ูุงุญุฏุฉ ุนูู ุงูุฃูู!", "โ๏ธ");
        return;
      }

      const CHARACTERS = getCharacters();
      const selectedData = Array.from(selectedChars).map(id => CHARACTERS.find(c => c.id === id));
      const totalText = document.getElementById('totalPrice').innerText;
      const finalPrice = parseFloat(totalText);

      // Store data for next step
      pendingOrderData = {
        tier: selectedTier,
        characters: selectedData,
        totalPrice: finalPrice
      };

      // Close character modal and open Steam modal
      closeCharModal();
      openSteamModal();
    };

    // Steam Modal Functions
    window.openSteamModal = () => {
      document.getElementById('steamModal').classList.add('visible');
    };

    window.closeSteamModal = () => {
      document.getElementById('steamModal').classList.remove('visible');
    };

    // Confirm Steam Login
    document.getElementById('confirmSteamLogin').onclick = async () => {
      if (!pendingOrderData) return;

      const loginMethod = document.querySelector('input[name="loginMethod"]:checked').value;
      let steamData = {};

      if (loginMethod === 'credentials') {
        const user = document.getElementById('steamUsername').value.trim();
        const pass = document.getElementById('steamPassword').value.trim();
        if (!user || !pass) {
          alert("ูุฑุฌู ูุชุงุจุฉ ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑุ ุฃู ุงุฎุชูุงุฑ ุทุฑููุฉ QR.");
          return;
        }
        steamData = { method: 'credentials', username: user, password: pass };
      } else {
        steamData = { method: 'qr' };
      }

      closeSteamModal();
      showToast("ุฌุงุฑู ูุนุงูุฌุฉ ุงูุทูุจ...", "โณ");

      await placeOrder(pendingOrderData.tier, pendingOrderData.characters, pendingOrderData.totalPrice, steamData);

      // Clear inputs
      document.getElementById('steamUsername').value = '';
      document.getElementById('steamPassword').value = '';
      pendingOrderData = null;
    };

    // --- Manual Payment Logic ---
    const paymentModal = document.getElementById('paymentModal');
    const receiptInput = document.getElementById('receiptInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const submitPayment = document.getElementById('submitPayment');
    let currentOrderForPayment = null;

    window.showPaymentModal = (details) => {
      currentOrderForPayment = details;
      document.getElementById('payAmount').innerText = `${details.totalPrice} ุฌููู`;
      document.getElementById('payWallet').innerText = details.walletNumber;
      paymentModal.classList.add('visible');
    };

    window.closePaymentModal = () => {
      paymentModal.classList.remove('visible');
    };

    window.copyWalletNumber = () => {
      const num = document.getElementById('payWallet').innerText;
      navigator.clipboard.writeText(num);
      showToast("ุชู ูุณุฎ ุงูุฑูู!", "๐");
    };

    receiptInput.onchange = (e) => {
      if (e.target.files.length > 0) {
        fileNameDisplay.innerText = e.target.files[0].name;
        fileNameDisplay.style.color = 'var(--primary)';
      }
    };

    window.resumePayment = (orderId) => {
      const order = lastOrders.find(o => o.id === orderId);
      if (!order) return;

      const details = {
        orderId: order.id,
        totalPrice: order.totalPrice,
        walletNumber: '01015831676',
        tier: order.tier,
        characters: order.characters
      };
      showPaymentModal(details);
    };

    window.cancelOrder = (orderId) => {
      showConfirm("ูู ุฃูุช ูุชุฃูุฏ ูู ุฑุบุจุชู ูู ุฅูุบุงุก ูุฐุง ุงูุทูุจุ ูุง ูููู ุงูุชุฑุงุฌุน ุนู ูุฐู ุงูุฎุทูุฉ.", () => {
        updateOrderStatus(orderId, 'rejected');
        showToast("ุชู ุฅูุบุงุก ุงูุทูุจ ุจูุฌุงุญ.", "๐๏ธ");
      });
    };


    submitPayment.onclick = async () => {
      const wallet = document.getElementById('senderWalletInput').value.trim();
      if (!wallet) {
        showToast("ูุฑุฌู ุฅุฏุฎุงู ุฑูู ุงููุญูุธุฉ ุงููุญูู ููู!", "โ๏ธ");
        return;
      }
      if (receiptInput.files.length === 0) {
        showToast("ูุฑุฌู ุฑูุน ุตูุฑุฉ ุงูุฅูุตุงู ุฃููุงู!", "โ๏ธ");
        return;
      }

      submitPayment.disabled = true;
      submitPayment.innerText = "ุฌุงุฑู ุงูุฅุฑุณุงู...";

      try {
        const orderId = currentOrderForPayment.orderId;
        const characters = currentOrderForPayment.characters || Array.from(selectedChars).map(id => getCharacters().find(c => c.id === id));

        const success = await sendPaymentProofToDiscord(
          orderId,
          receiptInput.files[0],
          {
            userName: auth.currentUser.displayName,
            tier: currentOrderForPayment.tier,
            totalPrice: currentOrderForPayment.totalPrice,
            characters: characters
          },
          wallet
        );

        if (success) {
          showToast("ุชู ุฅุฑุณุงู ุงูุฅูุตุงู ุจูุฌุงุญ! ุณูุชู ูุฑุงุฌุนุฉ ุทูุจู.", "โ");
          closePaymentModal();
        } else {
          throw new Error("Upload failed");
        }
      } catch (err) {
        showToast("ูุดู ูู ุฅุฑุณุงู ุงูุฅูุตุงู. ุญุงูู ูุฑุฉ ุฃุฎุฑู.", "โ");
        submitPayment.disabled = false;
        submitPayment.innerText = "ุฅุฑุณุงู ุงูุฅูุตุงู ูุชุฃููุฏ ุงูุทูุจ";
      }
    };



    window.updateStatus = (id, status) => {
      showConfirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุบููุฑ ุญุงูุฉ ุงูุทูุจ ุฅูู ${status === 'working' ? 'ุจุฏุก ุงูุนูู' : status === 'done' ? 'ุฅููุงุก' : 'ุฑูุถ'}ุ`, () => {
        updateOrderStatus(id, status);
      });
    };


    // ุชุญููู ุงูุทูุจุงุช ุงูุชู ุชู ุนุฑุถ ุฅุดุนุงุฑุงุช ููุง ูู localStorage
    const savedNotifs = localStorage.getItem('notifiedOrders');
    const notifiedOrders = new Set(savedNotifs ? JSON.parse(savedNotifs) : []);

    const startOrderListener = (uid) => {
      listenToUserOrders(uid, (orders) => {
        orders.forEach(order => {
          if ((order.status === 'done' || order.status === 'rejected') && !notifiedOrders.has(order.id)) {
            showNotification(order);
            notifiedOrders.add(order.id);
            // ุญูุธ ุงูุญุงูุฉ ูู localStorage
            localStorage.setItem('notifiedOrders', JSON.stringify(Array.from(notifiedOrders)));
          }
        });
      });
    };

    let currentOrderIdForRating = null;
    let selectedRatingValue = 0;

    const showNotification = (order) => {
      const modal = document.getElementById('notificationModal');
      const msg = document.getElementById('notifMessage');
      const title = document.getElementById('notifTitle');

      currentOrderIdForRating = order.id;

      // Reset to step 1
      document.getElementById('ratingStep1').classList.remove('hidden');
      document.getElementById('ratingStep2').classList.add('hidden');
      document.getElementById('ratingStep3').classList.add('hidden');
      document.getElementById('notifActions').style.display = 'flex';

      if (order.status === 'done') {
        title.innerText = 'ุชู ุงูุงูุชูุงุก! ๐';
        msg.innerText = `ููุฏ ุชู ุฅููุงู ุทูุจู (${order.tier}) ุจูุฌุงุญ. ุดูุฑุงู ูุซูุชู ุจูุง!`;
        document.getElementById('ratingContainer').classList.remove('hidden');
        setupRating();
      } else {
        title.innerText = 'ุชู ุฑูุถ ุงูุทูุจ';
        msg.innerText = `ุนุฐุฑุงูุ ุชู ุฑูุถ ุทูุจู (${order.tier}). ูุฑุฌู ุงูุชูุงุตู ูุน ุงูุฏุนู ูููุฒูุฏ ูู ุงูุชูุงุตูู.`;
        document.getElementById('ratingContainer').classList.add('hidden');
      }

      modal.classList.add('visible');
    };

    const setupRating = () => {
      const stars = document.querySelectorAll('.star');
      const step1 = document.getElementById('ratingStep1');
      const step2 = document.getElementById('ratingStep2');
      const step3 = document.getElementById('ratingStep3');
      const submitBtn = document.getElementById('submitRatingBtn');
      const actions = document.getElementById('notifActions');

      selectedRatingValue = 0;
      document.getElementById('reviewText').value = '';

      stars.forEach(star => {
        star.classList.remove('active');
        star.onclick = () => {
          selectedRatingValue = parseInt(star.dataset.value);
          stars.forEach((s) => {
            if (parseInt(s.dataset.value) <= selectedRatingValue) s.classList.add('active');
            else s.classList.remove('active');
          });

          // Auto transition to step 2 after a small delay
          setTimeout(() => {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            actions.style.display = 'none';
          }, 600);
        };
      });

      submitBtn.onclick = async () => {
        if (selectedRatingValue === 0) return;
        submitBtn.disabled = true;
        submitBtn.innerText = "ุฌุงุฑู ุงูุฅุฑุณุงู...";

        const review = document.getElementById('reviewText').value;
        const success = await submitRating(currentOrderIdForRating, selectedRatingValue, review);

        if (success) {
          step2.classList.add('hidden');
          step3.classList.remove('hidden');
          setTimeout(() => {
            actions.style.display = 'flex';
          }, 1000);
        } else {
          showToast("ูุดู ูู ุฅุฑุณุงู ุงูุชูููู.", "โ");
          submitBtn.disabled = false;
          submitBtn.innerText = "ุฅุฑุณุงู ุงูุชูููู ุงูููุงุฆู";
        }
      };
    };

    window.closeNotification = () => {
      document.getElementById('notificationModal').classList.remove('visible');
    };

    window.openCharLightbox = (img, name) => {
      const lightbox = document.getElementById('charLightbox');
      document.getElementById('lightboxImg').src = img || '2stars/3333.png';
      document.getElementById('lightboxName').innerText = name;
      lightbox.classList.add('visible');
    };

    window.closeCharLightbox = () => {
      document.getElementById('charLightbox').classList.remove('visible');
    };

    window.handleLogin = login;
    window.handleLogout = logout;

    let lastOrders = null;
    function renderQueue(orders) {
      lastOrders = orders;
      queueList.innerHTML = '';
      if (orders.length === 0) {
        queueBrief.innerText = "ูุง ููุฌุฏ ุฃุญุฏ ูู ุงูุทุงุจูุฑ ุญุงููุงู. ูู ุงูุฃูู!";
        return;
      }

      const user = auth.currentUser;
      const myOrderIndex = orders.findIndex(o => o.uid === user?.uid);
      if (myOrderIndex !== -1) {
        queueBrief.innerText = myOrderIndex === 0 && orders[0].status === 'working'
          ? "ุฃูุช ุงูุฃู ูู ูุฑุญูุฉ ุงูุชูููุฐ! ๐"
          : `ุฃูุช ูู ุงููุฑูุฒ #${myOrderIndex + 1}ุ ููุฌุฏ ${myOrderIndex} ูุจูู.`;
      } else {
        queueBrief.innerText = `ููุฌุฏ ุญุงููุงู ${orders.length} ุทูุจุงุช ูู ุงูุทุงุจูุฑ.`;
      }

      orders.forEach((order, index) => {
        const isWorking = order.status === 'working';
        const isPending = order.status === 'pending_verification';
        const isAwaiting = order.status === 'awaiting_payment';

        const item = document.createElement('div');
        item.className = `queue-item ${isWorking ? 'active' : ''} ${order.uid === user?.uid ? 'mine' : ''}`;

        let statusBadge = isWorking ? '<span style="font-size:0.8rem">๐ฅ ุฌุงุฑู ุงูุนูู</span>' : `#${index + 1}`;
        if (isPending) statusBadge = '<span style="font-size:0.75rem; color:var(--primary);">โณ ุฌุงุฑู ูุฑุงุฌุนุฉ ุงูุฅูุตุงู</span>';
        if (isAwaiting) statusBadge = '<span style="font-size:0.75rem; color:var(--text-dim);">๐ธ ุจุงูุชุธุงุฑ ุงูุฏูุน</span>';

        let workerInfo = '';
        if (isWorking && order.workerAvatar) {
          workerInfo = `
                    <div style="display:flex; align-items:center; gap:5px; font-size:0.75rem; color:var(--primary);">
                         <span>ุจูุงุณุทุฉ:</span>
                         <img src="${order.workerAvatar}" style="width:20px; height:20px; border-radius:50%; border:1px solid var(--primary)" loading="lazy">
                         <span>${order.workerName.split(' ')[0]}</span>
                    </div>
                `;
        }

        const characters = order.characters || [{ name: order.charName, image: order.charImage }];

        // Show More Logic
        const limit = 6;
        const visibleChars = characters.slice(0, limit);
        const hiddenChars = characters.slice(limit);

        const generateCharTag = (c, hidden = false) => `
          <div class="${hidden ? `hidden-char-${order.id}` : ''}" 
               style="${hidden ? 'display:none;' : 'display:inline-flex;'} align-items:center; gap:8px; background:rgba(255,255,255,0.08); padding:4px 10px; border-radius:12px; font-size:0.85rem; border:1px solid var(--glass-border); cursor:pointer; transition: 0.3s;"
               onclick="openCharLightbox('${c.image}', '${c.name || 'ุดุฎุตูุฉ'}')">
            ${c.image ? `<img src="${c.image}" style="width:30px; height:30px; border-radius:50%; border:1px solid var(--primary);" loading="lazy">` : '๐ก๏ธ'}
            <span style="font-weight: 700;">${c.name}</span>
          </div>
        `;

        const visibleTags = visibleChars.map(c => generateCharTag(c)).join(' ');
        const hiddenTags = hiddenChars.map(c => generateCharTag(c, true)).join(' ');

        let moreBtn = '';
        if (hiddenChars.length > 0) {
          moreBtn = `
                <button onclick="document.querySelectorAll('.hidden-char-${order.id}').forEach(el => el.style.display='inline-flex'); this.style.display='none';" 
                    style="background:rgba(0, 242, 254, 0.1); border:1px solid var(--primary); color:white; border-radius:10px; padding:2px 8px; font-size:0.75rem; cursor:pointer;">
                    ุนุฑุถ ุงููุฒูุฏ (+${hiddenChars.length})
                </button>
            `;
        }

        item.innerHTML = `
                <div style="display:flex; flex-direction:column; flex:1">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <img src="${order.userAvatar}" style="width:30px; height:30px; border-radius:50%" loading="lazy">
                        <strong>${order.userName.split(' ')[0]} - ${order.tier}</strong>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-right:40px;">
                        ${visibleTags}
                        ${hiddenTags}
                        ${moreBtn}
                    </div>
                    ${workerInfo}
                </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                    <span class="pos-tag" style="display:flex; flex-direction:column; align-items:flex-end;">
                        ${statusBadge}
                    </span>
                    ${(isAwaiting && order.uid === user?.uid) ? `
                      <div style="display:flex; gap:5px;">
                        <button onclick="resumePayment('${order.id}')" class="auth-btn" style="padding: 4px 10px; font-size: 0.7rem; border-radius: 8px; margin-top: 5px; background: var(--primary); color: #000; border: none;">
                          ุงุณุชููุงู ุงูุฏูุน ๐ณ
                        </button>
                        <button onclick="cancelOrder('${order.id}')" class="auth-btn" style="padding: 4px 10px; font-size: 0.7rem; border-radius: 8px; margin-top: 5px; background: rgba(255, 77, 77, 0.2); color: #ff4d4d; border: 1px solid #ff4d4d;">
                          ุฅูุบุงุก ๐๏ธ
                        </button>
                      </div>
                    ` : ''}
                    ${(order.status === 'working' && order.uid === user?.uid) ? `
                      <button id="customer-chat-btn-${order.id}" onclick="openChat('${order.id}')" class="auth-btn" style="position:relative; padding: 4px 12px; font-size: 0.75rem; border-radius: 8px; margin-top: 5px; background: #4facfe; color: #fff; border: none; display:flex; align-items:center; gap:5px;">
                        <span>ุชูุงุตู ูุน ุงูููุธู</span> ๐ฌ
                      </button>
                    ` : ''}
                </div>
    `;
        queueList.appendChild(item);

        if (isWorking && order.uid === user?.uid) {
          listenToUnreadCount(order.id, user.uid, (count) => {
            const btn = document.getElementById(`customer - chat - btn - ${order.id}`);
            if (btn) {
              const existingBadge = btn.querySelector('.notification-badge');
              if (existingBadge) existingBadge.remove();

              if (count > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.innerText = count > 9 ? '9+' : count;
                btn.appendChild(badge);
              }
            }
          });
        }
      });
    }

    // --- Operations Modal Logic Removed (Now in app.js/ui.js) ---

    listenToQueue(renderQueue);
  </script>
</body>

</html>