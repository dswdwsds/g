<!DOCTYPE html>
<html lang="ar">

<head>
  <meta http-equiv="Content-Security-Policy"
    content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com https://www.gstatic.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://www.gstatic.com; img-src 'self' data: https://*.discordapp.com https://*.discordapp.net https://*.googleusercontent.com https://lh3.googleusercontent.com https://via.placeholder.com https://ui-avatars.com https://*.ibb.co; font-src 'self' https://fonts.gstatic.com; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://discord.com https://*.discordapp.com https://www.gstatic.com https://api.imgbb.com; frame-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://apis.google.com;">
  <meta charset="UTF-8">
  <link rel="icon" href="https://ui-avatars.com/api/?name=BR&background=00f2fe&color=000">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description"
    content="Ø®Ø¯Ù…Ø© ØªØ·ÙˆÙŠØ± Ø´Ø®ØµÙŠØ§Øª Ù„Ø¹Ø¨Ø© Bounty Rush - Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØ·ÙˆØ± Ø´Ø®ØµÙŠØ§ØªÙƒ Ø§Ù„Ù…ÙØ¶Ù„Ø© Ø¨Ø³Ø±Ø¹Ø© ÙˆØ£Ù…Ø§Ù† Ù…Ø¹ PRO GS.">
  <meta property="og:title" content="ØªØ·ÙˆÙŠØ± Ø´Ø®ØµÙŠØ§Øª Bounty Rush | PRO GS">
  <meta property="og:description" content="Ø£Ø³Ø±Ø¹ Ø®Ø¯Ù…Ø© Ù„ØªØ·ÙˆÙŠØ± Ø´Ø®ØµÙŠØ§Øª Ø¨Ø§ÙˆÙ†ØªÙŠ Ø±Ø§Ø´ Ø¨Ø£Ø³Ø¹Ø§Ø± ØªÙ†Ø§ÙØ³ÙŠØ©.">

  <title>ØªØ·ÙˆÙŠØ± Ø´Ø®ØµÙŠØ§Øª Bounty Rush | Professional GS</title>

  <!-- Optimized Font Loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+Arabic:wght@400;700;800&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    .rating-stars {
      display: flex;
      gap: 12px;
      justify-content: center;
      font-size: 2.8rem;
      margin: 15px 0;
      direction: ltr;
      /* Ensure star hover works left-to-right logic */
      user-select: none;
    }

    .star {
      cursor: pointer;
      color: rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
      display: inline-block;
    }

    /* Hover effect: make all previous stars yellow */
    .star:hover,
    .star:hover~.star {
      color: #ffd700 !important;
      transform: scale(1.2);
    }

    /* Fixed rating effect */
    .star.active {
      color: #ffd700 !important;
      text-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
    }

    /* Make sure stars don't flicker on hover */
    .rating-stars:hover .star {
      color: rgba(255, 255, 255, 0.1);
    }

    .rating-stars:hover .star:hover,
    .rating-stars:hover .star:hover~.star {
      color: #ffd700 !important;
    }

    .review-input {
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--glass-border);
      border-radius: 15px;
      color: white;
      padding: 15px;
      margin-bottom: 20px;
      font-family: var(--font-ar);
      resize: none;
    }
  </style>
</head>

<body>

  <nav class="nav-bar">
    <div class="user-info" id="userInfo">
      <!-- Auth Content -->
    </div>
    <a href="index.html" class="logo"
      style="text-decoration: none; font-family: var(--font-en); font-weight: 800; color: var(--primary);">PRO GS</a>
  </nav>

  <header class="hero" style="padding-top: 120px;">
    <h1>One Piece Bounty Rush</h1>
    <p>Ù†Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© Ø±ÙØ¹ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª Ø¨Ø³Ø±Ø¹Ø© ÙØ§Ø¦Ù‚Ø© ÙˆØ¶Ù…Ø§Ù† ÙƒØ§Ù…Ù„ Ø¶Ø¯ Ø£ÙŠ Ø®Ù„Ù„.</p>
  </header>

  <section class="queue-container" id="queueDashboard" class="hidden">
    <div class="queue-card">
      <span class="queue-status-tag">Live Queue ğŸ”´</span>
      <h2 style="margin-bottom: 5px;">Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
      <p id="queueBrief" style="color: var(--text-dim); font-size: 0.9rem;">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>

      <div class="queue-list" id="queueList">
        <!-- Queue items will appear here -->
      </div>
    </div>
  </section>

  <section class="character-tiers">
    <div class="tier-card">
      <span class="tier-stars">â­â­</span>
      <h3>Starter Tier</h3>
      <span class="tier-price">8<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</span></span>
      <p>Ø±ÙØ¹ Ø³Ø±ÙŠØ¹ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Starter')">Ø·Ù„Ø¨ Ù‡Ø°Ù‡
        Ø§Ù„ÙØ¦Ø©</button>
      <div class="offer-ribbon">Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØªØ§Ø­</div>
    </div>

    <div class="tier-card" style="border-color: var(--primary);">
      <span class="tier-stars">â­â­â­</span>
      <h3>Pro Tier</h3>
      <span class="tier-price">9<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</span></span>
      <p>ØªØ­Ø³ÙŠÙ† ÙƒØ¨ÙŠØ± Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø´Ø®ØµÙŠØ©</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Pro')">Ø·Ù„Ø¨ Ù‡Ø°Ù‡ Ø§Ù„ÙØ¦Ø©</button>
      <div class="offer-ribbon">Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØªØ§Ø­</div>
    </div>

    <div class="tier-card">
      <span class="tier-stars">â­â­â­â­</span>
      <h3>Ultimate Tier</h3>
      <span class="tier-price">10<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ</span></span>
      <p>Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ù‚ÙˆØ©</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%;" onclick="orderNow('Ultimate')">Ø·Ù„Ø¨ Ù‡Ø°Ù‡
        Ø§Ù„ÙØ¦Ø©</button>
      <div class="offer-ribbon">Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØªØ§Ø­</div>
    </div>
  </section>

  <!-- Special Bulk Offers -->
  <section class="character-tiers" style="margin-top: 50px;">
    <div class="tier-card" style="border-color: #00f2fe; background: rgba(0, 242, 254, 0.05);">
      <span class="tier-stars">â­â­ / â­â­â­</span>
      <h3>Ø¨Ø§Ù‚Ø© Ø§Ù„ØªÙˆÙÙŠØ±</h3>
      <span class="tier-price">100<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡</span></span>
      <p>20 Ø´Ø®ØµÙŠØ© (Ù…ÙŠÙƒØ³ Ù†Ø¬Ù…ØªÙŠÙ† ÙˆØ«Ù„Ø§Ø«)</p>
      <p style="font-size:0.8rem; color:#ff4d4d; margin-top:5px;">*Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%; background: #00f2fe; color:#000;"
        onclick="orderNow('BulkMix', event)">Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
      <div class="offer-ribbon new">Ø¹Ø±Ø¶ Ø®Ø§Øµ</div>
    </div>

    <div class="tier-card" style="border-color: #ff00c8; background: rgba(255, 0, 200, 0.05);">
      <span class="tier-stars">â­â­â­â­</span>
      <h3>Ø¨Ø§Ù‚Ø© Ø§Ù„Ù‚ÙˆØ©</h3>
      <span class="tier-price">140<span class="tier-currency"> Ø¬Ù†ÙŠÙ‡</span></span>
      <p>20 Ø´Ø®ØµÙŠØ© (Ø£Ø±Ø¨Ø¹ Ù†Ø¬ÙˆÙ…)</p>
      <p style="font-size:0.8rem; color:#ff4d4d; margin-top:5px;">*Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨</p>
      <button class="auth-btn" style="margin-top:20px; width: 100%; background: #ff00c8;"
        onclick="orderNow('BulkUltimate', event)">Ø·Ù„Ø¨ Ø§Ù„Ø¨Ø§Ù‚Ø©</button>
      <div class="offer-ribbon new">Ø¹Ø±Ø¶ Ø®Ø§Øµ</div>
    </div>
  </section>

  <section class="character-tiers" style="display:none;">
    <!-- Hidden original closing tag area placeholder if needed layout adjustment -->
  </section>

  <div style="text-align: center; margin-bottom: 100px;">
    <p class="note">
      ğŸ›¡ï¸ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¢Ù…Ù†Ø© ØªÙ…Ø§Ù…Ø§Ù‹ ÙˆØªØªÙ… Ø¹Ø¨Ø± Ø®Ø¨Ø±Ø§Ø¡ Ù…ØªØ®ØµØµÙŠÙ†.
      <br>
      âš ï¸ Ø¥Ø®Ù„Ø§Ø¡ Ù…Ø³Ø¤ÙˆÙ„ÙŠØ©: Ù†Ø­Ù† Ø¬Ù‡Ø© Ø®Ø§Ø±Ø¬ÙŠØ© ÙˆÙ„Ø§ Ù†ØªØ¨Ø¹ Ø´Ø±ÙƒØ© Bandai Namco.
    </p>
  </div>

  <!-- Notification Modal -->
  <div id="notificationModal" class="notif-overlay">
    <div class="notif-card"
      style="max-width: 500px; width: 95%; min-height: 300px; display: flex; flex-direction: column; justify-content: center;">
      <!-- Step 1: Announcement & Stars -->
      <div id="ratingStep1" class="rating-step">
        <h3 id="notifTitle">ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡! ğŸš€</h3>
        <p id="notifMessage">Ù„Ù‚Ø¯ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§!</p>

        <div id="ratingContainer" class="hidden"
          style="border-top: 1px solid var(--glass-border); margin-top: 20px; padding-top: 20px;">
          <p style="text-align: center; margin-bottom: 5px; font-weight: bold; color: var(--primary);">Ù…Ø§ Ø±Ø£ÙŠÙƒ ÙÙŠ Ø¬ÙˆØ¯Ø©
            Ø§Ù„Ø®Ø¯Ù…Ø©ØŸ â­</p>
          <div class="rating-stars" id="stars" style="flex-direction: row-reverse;">
            <span class="star" data-value="5">â˜…</span>
            <span class="star" data-value="4">â˜…</span>
            <span class="star" data-value="3">â˜…</span>
            <span class="star" data-value="2">â˜…</span>
            <span class="star" data-value="1">â˜…</span>
          </div>
        </div>
      </div>

      <!-- Step 2: Comment -->
      <div id="ratingStep2" class="rating-step hidden">
        <h3 style="color: var(--primary);">ÙŠØ³Ø¹Ø¯Ù†Ø§ Ø³Ù…Ø§Ø¹ Ø±Ø£ÙŠÙƒ! ğŸ’¬</h3>
        <p style="font-size: 0.9rem; color: var(--text-dim); margin-bottom: 15px;">Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªÙˆØ¯ Ù…Ø´Ø§Ø±ÙƒØªÙ‡Ø§ØŸ</p>
        <textarea id="reviewText" class="review-input" placeholder="Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ù‡Ù†Ø§..." rows="3"></textarea>
        <button class="notif-btn" id="submitRatingBtn"
          style="width: 100%; height: 50px; font-weight: 800; background: var(--primary); color: #000;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
          Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</button>
      </div>

      <!-- Step 3: Success -->
      <div id="ratingStep3" class="rating-step hidden" style="text-align: center;">
        <div class="success-check">âœ“</div>
        <h3 style="margin-bottom: 10px;">Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ! â¤ï¸</h3>
        <p style="color: var(--text-dim);">ØªÙ‚ÙŠÙŠÙ…Ùƒ ÙŠØ³Ø§Ø¹Ø¯Ù†Ø§ Ø¹Ù„Ù‰ ØªÙ‚Ø¯ÙŠÙ… Ø®Ø¯Ù…Ø© Ø£ÙØ¶Ù„ Ø¯Ø§Ø¦Ù…Ø§Ù‹.</p>
      </div>

      <div id="notifActions" style="display:flex; gap:10px; margin-top:20px;">
        <button class="notif-btn" id="viewHistoryBtn" onclick="location.href='history.html'">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
        <button class="notif-btn" style="background: var(--glass); color: #fff;"
          onclick="closeNotification()">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <!-- Character Selection Modal -->
  <div id="charModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 850px; width: 95%; padding: 25px;">
      <!-- Header -->
      <div style="border-bottom: 2px solid var(--glass-border); padding-bottom: 15px; margin-bottom: 20px;">
        <h3 style="margin: 0; font-size: 1.3rem;">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø®ØµÙŠØ§Øª (<span id="modalStars"></span>) ğŸ—¡ï¸</h3>
      </div>

      <!-- Character Grid -->
      <div id="charGrid" class="char-grid"
        style="max-height: 400px; overflow-y: auto; margin-bottom: 20px; padding: 10px;">
        <!-- Characters will be injected here -->
      </div>

      <!-- Info Section -->
      <div
        style="background: rgba(255, 235, 59, 0.08); border: 1px solid rgba(255, 235, 59, 0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px; text-align: right;">
        <div style="font-size: 0.85rem; color: #fff; line-height: 1.6;">
          <div style="margin-bottom: 8px;">
            âš ï¸ <strong style="color: #ffeb3b;">ØªÙ†Ø¨ÙŠÙ‡:</strong> Ø§Ù„Ø®Ø¯Ù…Ø© Ù…ØªØ§Ø­Ø© Ù„Ù…Ù†ØµØ© <strong>Steam</strong> ÙÙ‚Ø·
          </div>
          <div>
            ğŸ›¡ï¸ <strong style="color: #00f2fe;">Ø¶Ù…Ø§Ù† Ø§Ù„Ù…ÙˆØ³Ù…:</strong> Ù†Ø¶Ù…Ù† Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙ Ø·ÙˆØ§Ù„ Ø§Ù„Ù…ÙˆØ³Ù… + Ø¯Ø®ÙˆÙ„ Ù…Ø¬Ø§Ù†ÙŠ
            Ø¹Ù†Ø¯ Ø§Ù„Ù†Ø²ÙˆÙ„
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div class="modal-footer" style="border-top: 2px solid var(--glass-border); padding-top: 15px;">
        <div class="price-display" style="margin-bottom: 15px;">
          <div class="price-label" style="font-size: 0.9rem; color: var(--text-dim);">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</div>
          <div id="totalPrice" class="price-total" style="font-size: 1.8rem; font-weight: bold;">0 Ø¬Ù†ÙŠÙ‡</div>
        </div>

        <div id="selectionActions" style="display:flex; gap:10px; justify-content: center;">
          <button id="confirmSelection" class="notif-btn"
            style="flex: 1; max-width: 200px; padding: 14px 25px; font-size: 1.05rem;">ØªØ£ÙƒÙŠØ¯ (0)</button>
          <button class="notif-btn"
            style="flex: 1; max-width: 150px; background: var(--glass); color: #fff; padding: 14px 20px;"
            onclick="closeCharModal()">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Steam Login Modal -->
  <div id="steamModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 500px; width: 95%;">
      <h3 style="margin-bottom: 20px;">ğŸ” Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø§Ø¨ Steam</h3>

      <div
        style="background: rgba(255, 235, 59, 0.08); border: 1px solid rgba(255, 235, 59, 0.3); border-radius: 12px; padding: 12px; margin-bottom: 20px; text-align: right; font-size: 0.85rem;">
        âš ï¸ Ù†Ø­ØªØ§Ø¬ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ Ù„Ø¥ØªÙ…Ø§Ù… Ø§Ù„ØªÙ„ÙÙŠÙ„. Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­Ù…ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆÙ„Ù† ØªÙØ³ØªØ®Ø¯Ù… Ù„Ø£ÙŠ ØºØ±Ø¶ Ø¢Ø®Ø±.
      </div>

      <div style="text-align: right; margin-bottom: 20px;">
        <p style="margin-bottom: 12px; font-weight: bold; color: var(--primary);">Ø§Ø®ØªØ± Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„:</p>

        <div style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="loginMethod" value="credentials" checked onchange="toggleLoginInputs()">
            <span>Ø­Ø³Ø§Ø¨ Steam (Ø§Ø³Ù… + Ø¨Ø§Ø³ÙˆØ±Ø¯)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
            <input type="radio" name="loginMethod" value="qr" onchange="toggleLoginInputs()">
            <span>QR Code (ØªÙˆØ§ØµÙ„ Ø¯Ø¹Ù…)</span>
          </label>
        </div>

        <form onsubmit="event.preventDefault(); document.getElementById('confirmSteamLogin').click();">
          <div id="steamInputs" style="display: block;">
            <input type="text" id="steamUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Steam Username)" class="review-input"
              style="margin-bottom: 10px; width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 8px;">
            <input type="password" id="steamPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (Password)" class="review-input"
              style="width: 100%; background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border); padding: 12px; border-radius: 8px;">
          </div>
        </form>

        <!-- QR Code Info -->
        <div id="qrInfo"
          style="display: none; background: rgba(0, 242, 254, 0.08); border: 1px solid var(--primary); border-radius: 12px; padding: 15px; text-align: right; line-height: 1.8;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: var(--primary);">ğŸ“± Ø·Ø±ÙŠÙ‚Ø© QR Code:</p>
          <p style="margin: 0 0 8px 0; font-size: 0.9rem;">
            âœ… Ø¨Ø¹Ø¯ Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨Ùƒ ÙˆÙˆØµÙˆÙ„ Ø¯ÙˆØ±ÙƒØŒ Ø£Ø­Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ø¯Ø¹Ù… Ø³ÙŠØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ø¹Ø¨Ø± Discord Ù„Ø¥Ø±Ø³Ø§Ù„ QR Code.
          </p>
          <p style="margin: 0 0 12px 0; font-size: 0.85rem; color: #ffeb3b;">
            âš¡ <strong>Ù„Ù„Ø£Ø³Ø±Ø¹:</strong> Ø¥Ø°Ø§ Ø£Ø¯Ø®Ù„Øª Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ø³Ù†Ø¨Ø¯Ø£ Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ø§Ù†ØªØ¸Ø§Ø±!
            (ÙŠÙ…ÙƒÙ†Ùƒ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¹Ø¨Ø± Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© Ø£ÙŠØ¶Ø§Ù‹)
          </p>
          <a href="https://discord.com/channels/1284591581717987422/1284591582187622539" target="_blank"
            style="display: inline-flex; align-items: center; gap: 6px; background: #5865F2; color: white; padding: 10px 16px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9rem;">
            <span>Discord</span> ğŸ’¬
          </a>
        </div>
      </div>

      <div style="display: flex; gap: 10px;">
        <button id="confirmSteamLogin" class="notif-btn" style="flex: 1; padding: 14px;">Ù…ØªØ§Ø¨Ø¹Ø© Ù„Ù„Ø¯ÙØ¹</button>
        <button class="notif-btn" style="flex: 1; background: var(--glass); color: #fff; padding: 14px;"
          onclick="closeSteamModal()">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <div id="paymentModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 500px; width: 95%;">
      <h3>Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹ ğŸ’¸</h3>
      <p style="text-align: center; color: var(--text-dim); margin-bottom: 20px;">ÙŠØ±Ø¬Ù‰ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.
      </p>

      <div class="payment-info-box">
        <div class="price-row">
          <span>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªØ­Ù‚:</span>
          <strong id="payAmount" style="color: var(--primary); font-size: 1.5rem;">0 Ø¬Ù†ÙŠÙ‡</strong>
        </div>
        <div class="wallet-row">
          <span>Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© (Vodafone Cash):</span>
          <div class="copy-box" onclick="copyWalletNumber()">
            <strong id="payWallet">01015831676</strong>
            <span style="font-size: 0.8rem; opacity: 0.7;">ğŸ“‹ Ù†Ø³Ø®</span>
          </div>
        </div>
      </div>

      <div class="upload-section">
        <div style="margin-bottom: 20px;">
          <p style="font-size: 0.9rem; margin-bottom: 10px;">Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø°ÙŠ Ù‚Ù…Øª Ø¨Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ù…Ù†Ù‡:</p>
          <input type="text" id="senderWalletInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙˆÙ„ (Ù…Ø«Ø§Ù„: 010...)"
            style="width: 100%; padding: 12px; border-radius: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--glass-border); color: white; outline: none;">
        </div>
        <p style="font-size: 0.9rem; margin-bottom: 10px;">Ù‚Ù… Ø¨Ø±ÙØ¹ ØµÙˆØ±Ø© Ø¥ÙŠØµØ§Ù„ Ø§Ù„Ø¯ÙØ¹ (Screenshot):</p>
        <label class="custom-upload">
          <input type="file" id="receiptInput" accept="image/*" hidden>
          <div class="upload-placeholder" id="uploadPlaceholder">
            <span style="font-size: 2rem;">ğŸ“¸</span>
            <p id="fileNameDisplay">Ø§Ø¶ØºØ· Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©</p>
          </div>
        </label>
      </div>

      <div class="modal-footer" style="padding: 0; margin-top: 25px; border: none;">
        <button id="submitPayment" class="auth-btn" style="width: 100%; height: 50px;">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙˆØªØ£ÙƒÙŠØ¯
          Ø§Ù„Ø·Ù„Ø¨</button>
        <button class="notif-btn"
          style="background: transparent; color: var(--text-dim); width: 100%; margin-top: 10px; border: none;"
          onclick="closePaymentModal()">Ø¥ØºÙ„Ø§Ù‚ (Ø³Ø£Ø¯ÙØ¹ Ù„Ø§Ø­Ù‚Ø§Ù‹)</button>
      </div>
    </div>
  </div>

  <!-- Custom Confirm Modal -->
  <div id="confirmModal" class="confirm-overlay">
    <div class="confirm-card">
      <div id="confirmTitle" class="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</div>
      <p id="confirmMsg" class="confirm-msg"></p>
      <div class="confirm-actions">
        <button id="confirmYes" class="confirm-btn yes">Ù†Ø¹Ù…ØŒ Ù…ØªØ£ÙƒØ¯</button>
        <button id="confirmNo" class="confirm-btn no">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- Chat Modal -->
  <div id="chatModal" class="chat-modal">
    <div class="chat-container">
      <div class="chat-header">
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="position:relative;">
            <img id="chatTargetAvatar" src=""
              style="width:35px; height:35px; border-radius:50%; border:1px solid var(--primary)">
            <div
              style="position:absolute; bottom:0; right:0; width:10px; height:10px; background:#00ff00; border-radius:50%; border:2px solid #000;">
            </div>
          </div>
          <div>
            <div id="chatTargetName" style="font-weight:bold; font-size:0.9rem;">Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù</div>
            <div style="font-size:0.7rem; color:var(--text-dim);">Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†</div>
          </div>
        </div>
        <button class="auth-btn" style="background:none; border:none; font-size:1.2rem; padding:0;"
          onclick="closeChat()">âœ–</button>
      </div>
      <div id="chatMessages" class="chat-messages">
        <div class="chat-empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
      </div>
      <div id="uploadProgress"
        style="display:none; padding:10px; background:rgba(0,242,254,0.1); font-size:0.8rem; text-align:center; color:var(--primary);">
        â³ Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...
      </div>
      <div class="chat-input-area">
        <input type="file" id="chatImageInput" accept="image/*" hidden>
        <button onclick="document.getElementById('chatImageInput').click()" class="chat-send-btn"
          style="background:rgba(255,255,255,0.1); font-size:1.1rem;">ğŸ“¸</button>
        <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ù‡Ù†Ø§..." autocomplete="off">
        <button id="sendMessageBtn" class="chat-send-btn">ğŸ•Šï¸</button>
      </div>
    </div>
  </div>

  <footer>
    <p>Â© 2026 Professional Game Services. All rights reserved.</p>
  </footer>

  <!-- Operations History Modal -->
  <div id="operationsModal" class="notif-overlay">
    <div class="notif-card ops-modal">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª ğŸ“‚</h3>
        <button class="auth-btn" style="background:none; border:none; padding:5px; min-width:auto; font-size: 1.2rem;"
          onclick="closeOperationsModal()">âœ–</button>
      </div>

      <div class="search-container">
        <input type="text" id="opsSearchInput" class="search-input" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨ (Order ID)..."
          onkeypress="if(event.key === 'Enter') handleOpsSearch()">
        <button onclick="handleOpsSearch()" class="auth-btn" style="padding: 10px 18px; margin-right: 5px;">Ø¨Ø­Ø«</button>
      </div>

      <div id="opsList" class="ops-list">
        <!-- Operations will load here -->
        <div class="ops-empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</div>
      </div>
    </div>
  </div>

  <!-- Order Details Modal -->
  <div id="opsDetailsModal" class="notif-overlay">
    <div class="notif-card" style="max-width: 500px; width: 95%;">
      <h3 style="margin-bottom: 20px;">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ğŸ“‹</h3>
      <div id="opsDetailsContent" style="text-align: right; line-height: 1.6; font-size: 0.9rem;"></div>
      <button class="notif-btn" style="margin-top: 20px;" onclick="closeOpsDetailsModal()">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Floating Support Button -->
  <a href="https://discord.com/channels/1284591581717987422/1284591582187622539" target="_blank"
    class="floating-support-btn">
    <span>ğŸ§</span>
    <span>ØªØ­Ø¯Ø« Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù…</span>
  </a>

  <script type="module">
    import { auth, onAuthStateChanged } from './firebase-config.js';
    import { login, logout, placeOrder, sendPaymentProofToDiscord, updateOrderStatus, listenToQueue, listenToUserOrders, listenToWorkers, getUserRole, submitRating, loadCharacters, getCharacters, sendMessage, listenToMessages, sendImageMessage, listenToUnreadCount, markMessagesAsRead, hasUserPurchasedOffer, listenToAllOrdersExtended, getOrderById } from './app.js?v=2';

    const userInfo = document.getElementById('userInfo');
    const queueList = document.getElementById('queueList');
    const queueBrief = document.getElementById('queueBrief');
    const charGrid = document.getElementById('charGrid');
    const charModal = document.getElementById('charModal');
    const notificationModal = document.getElementById('notificationModal'); // Added for new notification modal logic

    let selectedTier = null;
    let selectedChars = new Set();

    // Base Prices
    const TIER_PRICES = { 'Starter': 8, 'Pro': 9, 'Ultimate': 10 };
    // Offer Prices (5-10 chars)
    const OFFER_PRICES = { 'Starter': 6, 'Pro': 7, 'Ultimate': 8 };

    const TIER_STARS = {
      'Starter': 2,
      'Pro': 3,
      'Ultimate': 4,
      'BulkMix': [2, 3], // Mix of 2 and 3 stars
      'BulkUltimate': 4
    };

    // Load characters on page load
    loadCharacters().then(() => {
      console.log('Characters loaded:', getCharacters().length);
    });

    // Toggle Login Inputs (Steam vs QR)
    window.toggleLoginInputs = () => {
      const method = document.querySelector('input[name="loginMethod"]:checked').value;
      const steamInputs = document.getElementById('steamInputs');
      const qrInfo = document.getElementById('qrInfo');

      if (method === 'credentials') {
        steamInputs.style.display = 'block';
        qrInfo.style.display = 'none';
      } else {
        steamInputs.style.display = 'none';
        qrInfo.style.display = 'block';
      }
    };

    window.orderNow = async (tier, event) => {
      if (!auth.currentUser) {
        login();
        return;
      }

      // Check for one-time offer eligibility
      if (tier.startsWith('Bulk')) {
        const btn = event.target; // Capture button to maybe show loader?
        const originalText = btn.innerText;
        btn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...";
        btn.disabled = true;

        const hasPurchased = await hasUserPurchasedOffer(auth.currentUser.uid, tier);

        btn.innerText = originalText;
        btn.disabled = false;

        if (hasPurchased) {
          if (window.showToast) window.showToast("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù…ØªØ§Ø­ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨! ğŸš«", "âŒ");
          else alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶ Ù…ØªØ§Ø­ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· Ù„ÙƒÙ„ Ø­Ø³Ø§Ø¨! ğŸš«");
          return;
        }
      }

      selectedTier = tier;
      selectedChars.clear();

      openCharModal();
    };

    const openCharModal = () => {
      const CHARACTERS = getCharacters();
      const starsCriteria = TIER_STARS[selectedTier];

      // Filter Logic handling Array (for mix) or Number
      let filteredChars = [];
      let titleChars = "";

      if (Array.isArray(starsCriteria)) {
        filteredChars = CHARACTERS.filter(char => starsCriteria.includes(char.stars));
        titleChars = starsCriteria.map(s => s + ' Ù†Ø¬ÙˆÙ…').join(' Ùˆ ');
      } else {
        filteredChars = CHARACTERS.filter(char => char.stars === starsCriteria);
        titleChars = starsCriteria + ' Ù†Ø¬ÙˆÙ…';
      }

      document.getElementById('modalStars').innerText = titleChars;

      // Inject Offer Banner if applicable
      const offerBanner = document.getElementById('offerBanner');
      if (offerBanner) offerBanner.remove(); // Clean up old one

      if (!selectedTier.startsWith('Bulk')) {
        const discountPrice = OFFER_PRICES[selectedTier];
        const banner = document.createElement('div');
        banner.id = 'offerBanner';
        banner.style.cssText = "background: rgba(0, 242, 254, 0.1); border: 1px dashed var(--primary); color: var(--text); padding: 10px; margin-bottom: 15px; border-radius: 8px; text-align: center; font-size: 0.9rem;";
        banner.innerHTML = `ğŸ”¥ <strong>Ø¹Ø±Ø¶ Ø®Ø§Øµ:</strong> Ø§Ø®ØªØ± Ø¨ÙŠÙ† 5 Ùˆ 10 Ø´Ø®ØµÙŠØ§Øª Ù„ÙŠØµØ¨Ø­ Ø§Ù„Ø³Ø¹Ø± <span style="color:#00f2fe; font-weight:bold;">${discountPrice} Ø¬Ù†ÙŠÙ‡</span> Ù„Ù„Ø´Ø®ØµÙŠØ©!`;
        charGrid.parentElement.insertBefore(banner, charGrid);
      }

      if (filteredChars.length === 0) {
        charGrid.innerHTML = `
          <div style="grid-column: 1/-1; padding: 40px; text-align: center; color: var(--text-dim);">
            <div style="font-size: 3rem; margin-bottom: 20px;">ğŸ”</div>
            <p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ø®ØµÙŠØ§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</p>
          </div>
        `;
      } else {
        charGrid.innerHTML = filteredChars.map(char => `
          <div class="char-item" id="char-${char.id}" onclick="toggleChar('${char.id}')">
            <div style="width:80px; height:80px; border-radius:50%; border:2px solid var(--glass-border); background: linear-gradient(135deg, var(--primary), var(--accent)); display:flex; align-items:center; justify-content:center; margin:0 auto 10px;">
              <span style="font-size:1.5rem;">${char.stars === 5 ? 'ğŸŒŸ' : 'â­'.repeat(char.stars)}</span>
            </div>
            <div class="char-info">
              <div class="char-name">${char.name}</div>
              <div class="char-meta">${char.stars}â˜… | ${char.role}</div>
            </div>
          </div>
        `).join('');
      }
      updateSelectionUI();
      charModal.classList.add('visible');
    };

    window.closeCharModal = () => {
      charModal.classList.remove('visible');
    };

    window.toggleChar = (charId) => {
      // Bulk Limit Check
      if (selectedTier.startsWith('Bulk') && !selectedChars.has(charId) && selectedChars.size >= 20) {
        alert("ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø®ØªÙŠØ§Ø± 20 Ø´Ø®ØµÙŠØ© ÙÙ‚Ø· ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø±Ø¶!");
        return;
      }

      if (selectedChars.has(charId)) {
        selectedChars.delete(charId);
        document.getElementById(`char-${charId}`).classList.remove('selected');
      } else {
        selectedChars.add(charId);
        document.getElementById(`char-${charId}`).classList.add('selected');
      }
      updateSelectionUI();
    };

    const updateSelectionUI = () => {
      let total = 0;
      let count = selectedChars.size;
      let isValid = true;
      let statusMsg = "";
      let offerProgressMsg = "";

      if (selectedTier === 'BulkMix') {
        total = 100;
        if (count !== 20) {
          isValid = false;
          statusMsg = ` (ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± 20 Ø´Ø®ØµÙŠØ© - Ø§Ø®ØªØ±Øª ${count})`;
        }
      }
      else if (selectedTier === 'BulkUltimate') {
        total = 140;
        if (count !== 20) {
          isValid = false;
          statusMsg = ` (ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± 20 Ø´Ø®ØµÙŠØ© - Ø§Ø®ØªØ±Øª ${count})`;
        }
      }
      else {
        // Dynamic Pricing for Standard Tiers (Opening Offer)
        const isOffer = count >= 5 && count <= 10;
        const price = isOffer ? OFFER_PRICES[selectedTier] : TIER_PRICES[selectedTier];
        total = price * count;

        if (isOffer) {
          statusMsg = ` <br><span style="color:#00f2fe; font-size:0.8rem;">ğŸ”¥ Ø§Ù„Ø¹Ø±Ø¶ Ù…ÙØ¹Ù„! (Ø§Ù„Ø³Ø¹Ø± ${price}Ø¬ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† ${TIER_PRICES[selectedTier]}Ø¬)</span>`;
        } else if (count > 0 && count < 5) {
          const needed = 5 - count;
          offerProgressMsg = `<div style="margin-top:5px; color: var(--accent); font-size:0.8rem;">ğŸ’¡ Ø§Ø®ØªØ± <strong>${needed}</strong> Ø´Ø®ØµÙŠØ§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø§Øµ!</div>`;
        }

        if (count === 0) isValid = false;
      }

      const totalElement = document.getElementById('totalPrice');
      totalElement.innerHTML = `${total} Ø¬Ù†ÙŠÙ‡${statusMsg} ${offerProgressMsg}`; // Use innerHTML for formatting

      const btn = document.getElementById('confirmSelection');
      btn.innerText = `ØªØ£ÙƒÙŠØ¯ (${count})${isValid ? '' : ' âŒ'}`;
      btn.disabled = !isValid;
      btn.style.opacity = !isValid ? '0.5' : '1';
    };

    // Store order info temporarily
    let pendingOrderData = null;

    document.getElementById('confirmSelection').onclick = () => {
      if (selectedChars.size === 0) {
        showToast("ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø´Ø®ØµÙŠØ© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!", "âš ï¸");
        return;
      }

      const CHARACTERS = getCharacters();
      const selectedData = Array.from(selectedChars).map(id => CHARACTERS.find(c => c.id === id));
      const totalText = document.getElementById('totalPrice').innerText;
      const finalPrice = parseFloat(totalText);

      // Store data for next step
      pendingOrderData = {
        tier: selectedTier,
        characters: selectedData,
        totalPrice: finalPrice
      };

      // Close character modal and open Steam modal
      closeCharModal();
      openSteamModal();
    };

    // Steam Modal Functions
    window.openSteamModal = () => {
      document.getElementById('steamModal').classList.add('visible');
    };

    window.closeSteamModal = () => {
      document.getElementById('steamModal').classList.remove('visible');
    };

    // Confirm Steam Login
    document.getElementById('confirmSteamLogin').onclick = async () => {
      if (!pendingOrderData) return;

      const loginMethod = document.querySelector('input[name="loginMethod"]:checked').value;
      let steamData = {};

      if (loginMethod === 'credentials') {
        const user = document.getElementById('steamUsername').value.trim();
        const pass = document.getElementById('steamPassword').value.trim();
        if (!user || !pass) {
          alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŒ Ø£Ùˆ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø±ÙŠÙ‚Ø© QR.");
          return;
        }
        steamData = { method: 'credentials', username: user, password: pass };
      } else {
        steamData = { method: 'qr' };
      }

      closeSteamModal();
      showToast("Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø·Ù„Ø¨...", "â³");

      await placeOrder(pendingOrderData.tier, pendingOrderData.characters, pendingOrderData.totalPrice, steamData);

      // Clear inputs
      document.getElementById('steamUsername').value = '';
      document.getElementById('steamPassword').value = '';
      pendingOrderData = null;
    };

    // --- Manual Payment Logic ---
    const paymentModal = document.getElementById('paymentModal');
    const receiptInput = document.getElementById('receiptInput');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const submitPayment = document.getElementById('submitPayment');
    let currentOrderForPayment = null;

    window.showPaymentModal = (details) => {
      currentOrderForPayment = details;
      document.getElementById('payAmount').innerText = `${details.totalPrice} Ø¬Ù†ÙŠÙ‡`;
      document.getElementById('payWallet').innerText = details.walletNumber;
      paymentModal.classList.add('visible');
    };

    window.closePaymentModal = () => {
      paymentModal.classList.remove('visible');
    };

    window.copyWalletNumber = () => {
      const num = document.getElementById('payWallet').innerText;
      navigator.clipboard.writeText(num);
      showToast("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ù‚Ù…!", "ğŸ“‹");
    };

    receiptInput.onchange = (e) => {
      if (e.target.files.length > 0) {
        fileNameDisplay.innerText = e.target.files[0].name;
        fileNameDisplay.style.color = 'var(--primary)';
      }
    };

    window.resumePayment = (orderId) => {
      const order = lastOrders.find(o => o.id === orderId);
      if (!order) return;

      const details = {
        orderId: order.id,
        totalPrice: order.totalPrice,
        walletNumber: '01015831676',
        tier: order.tier,
        characters: order.characters
      };
      showPaymentModal(details);
    };

    window.cancelOrder = (orderId) => {
      showConfirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø±ØºØ¨ØªÙƒ ÙÙŠ Ø¥Ù„ØºØ§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©.", () => {
        updateOrderStatus(orderId, 'rejected');
        showToast("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­.", "ğŸ—‘ï¸");
      });
    };

    let chatUnsubscribe = null;
    let activeChatOrderId = null;

    window.openChat = (orderId) => {
      const order = lastOrders.find(o => o.id === orderId);
      if (!order) return;

      activeChatOrderId = orderId;
      document.getElementById('chatTargetName').innerText = order.workerName || "Ø§Ù„Ù…ÙˆØ¸Ù";
      // We don't have worker avatar easily accessible here without a separate fetch, using a default or order user dummy for now
      document.getElementById('chatTargetAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(order.workerName || 'W')}&background=00f2fe&color=000`;

      const modal = document.getElementById('chatModal');
      modal.classList.add('visible');

      const chatMessages = document.getElementById('chatMessages');
      chatMessages.innerHTML = '<div class="chat-empty">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>';

      if (chatUnsubscribe) chatUnsubscribe();

      chatUnsubscribe = listenToMessages(orderId, (messages) => {
        // Mark as read when messages load and chat is open
        markMessagesAsRead(orderId, auth.currentUser.uid);

        chatMessages.innerHTML = '';
        if (messages.length === 0) {
          chatMessages.innerHTML = '<div class="chat-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø¹Ø¯. Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© Ø§Ù„Ø¢Ù†! ğŸ‘‹</div>';
        } else {
          messages.forEach(msg => {
            const isMe = msg.senderId === auth.currentUser?.uid;
            const bubble = document.createElement('div');
            bubble.className = `message-bubble ${isMe ? 'sent' : 'received'}`;

            const time = msg.timestamp ? new Date(msg.timestamp.seconds * 1000).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '...';

            bubble.innerHTML = `
              <div class="message-info">
                ${!isMe ? `<img src="${msg.senderAvatar}" style="width:15px; height:15px; border-radius:50%">` : ''}
                <span>${isMe ? 'Ø£Ù†Ø§' : msg.senderName} â€¢ ${time}</span>
              </div>
              <div class="message-text">
                ${msg.text ? `<div>${msg.text}</div>` : ''}
                ${msg.image ? `
                  <a href="${msg.image}" target="_blank">
                    <img src="${msg.image}" style="max-width:100%; border-radius:10px; margin-top:5px; border:1px solid var(--glass-border); cursor:pointer;">
                  </a>
                ` : ''}
              </div>
            `;
            chatMessages.appendChild(bubble);
          });
          chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      });
    };

    window.closeChat = () => {
      document.getElementById('chatModal').classList.remove('visible');
      if (chatUnsubscribe) chatUnsubscribe();
      chatUnsubscribe = null;
      activeChatOrderId = null;
    };

    document.getElementById('sendMessageBtn').onclick = async () => {
      const input = document.getElementById('chatInput');
      const text = input.value.trim();
      if (!text || !activeChatOrderId) return;

      input.value = '';
      const success = await sendMessage(activeChatOrderId, text);
      if (!success) {
        showToast("ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©!", "âŒ");
        input.value = text;
      }
    };

    document.getElementById('chatInput').onkeypress = (e) => {
      if (e.key === 'Enter') document.getElementById('sendMessageBtn').click();
    };

    document.getElementById('chatImageInput').onchange = async (e) => {
      const file = e.target.files[0];
      if (!file || !activeChatOrderId) return;

      if (file.size > 32 * 1024 * 1024) {
        showToast("Ø­Ø¬Ù… Ø§Ù„ØµÙˆØ±Ø© ÙƒØ¨ÙŠØ± Ø¬Ø¯Ø§Ù‹! (Ø§Ù„Ø£Ù‚ØµÙ‰ 32 Ù…ÙŠØ¬Ø§)", "âš ï¸");
        return;
      }

      // Show progress bar
      const progressBar = document.getElementById('uploadProgress');
      progressBar.style.display = 'block';

      // showToast("Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©...", "â³"); // Replace with bar

      const success = await sendImageMessage(activeChatOrderId, file);

      // Hide progress bar
      progressBar.style.display = 'none';

      if (success) {
        // showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±Ø©!", "âœ…");
      } else {
        showToast("ÙØ´Ù„ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©!", "âŒ");
      }
      e.target.value = '';
    };

    submitPayment.onclick = async () => {
      const wallet = document.getElementById('senderWalletInput').value.trim();
      if (!wallet) {
        showToast("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ø­ÙˆÙ„ Ù…Ù†Ù‡!", "âš ï¸");
        return;
      }
      if (receiptInput.files.length === 0) {
        showToast("ÙŠØ±Ø¬Ù‰ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø£ÙˆÙ„Ø§Ù‹!", "âš ï¸");
        return;
      }

      submitPayment.disabled = true;
      submitPayment.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

      try {
        const orderId = currentOrderForPayment.orderId;
        const characters = currentOrderForPayment.characters || Array.from(selectedChars).map(id => getCharacters().find(c => c.id === id));

        const success = await sendPaymentProofToDiscord(
          orderId,
          receiptInput.files[0],
          {
            userName: auth.currentUser.displayName,
            tier: currentOrderForPayment.tier,
            totalPrice: currentOrderForPayment.totalPrice,
            characters: characters
          },
          wallet
        );

        if (success) {
          showToast("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø·Ù„Ø¨Ùƒ.", "âœ…");
          closePaymentModal();
        } else {
          throw new Error("Upload failed");
        }
      } catch (err) {
        showToast("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.", "âŒ");
        submitPayment.disabled = false;
        submitPayment.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨";
      }
    };


    // UI Helper Functions
    window.showToast = (message, icon = 'â„¹ï¸') => {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.innerHTML = `<span class="toast-icon">${icon}</span><span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => {
        toast.classList.add('removing');
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    };

    window.showConfirm = (message, onConfirm) => {
      const modal = document.getElementById('confirmModal');
      const msg = document.getElementById('confirmMsg');
      const yesBtn = document.getElementById('confirmYes');
      const noBtn = document.getElementById('confirmNo');

      msg.innerText = message;
      modal.classList.add('visible');

      const close = () => modal.classList.remove('visible');

      yesBtn.onclick = () => { onConfirm(); close(); };
      noBtn.onclick = close;
    };

    window.updateStatus = (id, status) => {
      showConfirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨ Ø¥Ù„Ù‰ ${status === 'working' ? 'Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„' : status === 'done' ? 'Ø¥Ù†Ù‡Ø§Ø¡' : 'Ø±ÙØ¶'}ØŸ`, () => {
        updateOrderStatus(id, status);
      });
    };

    // Ù†Ø­Ø¯Ø« Ø§Ù„ÙŠÙˆØ²Ø± ÙÙŠ ÙƒÙ„ Ù…Ø±Ø© ØªØªØºÙŠØ± ÙÙŠÙ‡Ø§ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ø§Ù„ Ø£Ùˆ Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
    const refreshUserUI = () => {
      const user = auth.currentUser;
      if (user) {
        const userRole = getUserRole(user.email);
        const isStaff = !!userRole;
        const workerBadge = isStaff ? `<span class="worker-badge">${userRole === 'admin' ? 'Admin ğŸ‘‘' : 'Staff ğŸ›¡ï¸'}</span>` : '';
        const workersLink = isStaff
          ? '<a href="workers.html" class="dropdown-item">âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</a>'
          : '';

        const opsButton = isStaff
          ? '<button class="auth-btn" style="padding: 8px 15px; margin-left: 10px; font-size: 0.85rem;" onclick="openOperationsModal()">ğŸ“‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>'
          : '';

        userInfo.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    ${opsButton}
                    <div class="user-dropdown">
                        <div class="user-profile">
                            <img src="${user.photoURL}" class="user-avatar" loading="lazy">
                            <span class="user-name">${user.displayName} ${workerBadge}</span>
                        </div>
                        <div class="dropdown-menu">
                            <a href="history.html" class="dropdown-item">ğŸ“‹ Ø·Ù„Ø¨Ø§ØªÙŠ</a>
                            ${workersLink}
                            <a href="#" class="dropdown-item" onclick="handleLogout()">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
                        </div>
                    </div>
                </div>
            `;
      } else {
        userInfo.innerHTML = `<button class="auth-btn" onclick="handleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„</button>`;
      }
    };

    // Ø§Ù„Ø¨Ø¯Ø¡ Ø¨Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¹Ù…Ø§Ù„
    listenToWorkers(() => {
      refreshUserUI();
      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù†ØªØ¸Ø§Ø± Ù…ÙØªÙˆØ­Ø©ØŒ Ù†Ø¹ÙŠØ¯ Ø¹Ø±Ø¶Ù‡Ø§ Ù„ØªØ¸Ù‡Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø¯Ù…Ù†
      if (lastOrders) renderQueue(lastOrders);
    });

    onAuthStateChanged(auth, (user) => {
      refreshUserUI();
      if (user) {
        startOrderListener(user.uid);
      }
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ ØªÙ… Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„Ù‡Ø§ Ù…Ù† localStorage
    const savedNotifs = localStorage.getItem('notifiedOrders');
    const notifiedOrders = new Set(savedNotifs ? JSON.parse(savedNotifs) : []);

    const startOrderListener = (uid) => {
      listenToUserOrders(uid, (orders) => {
        orders.forEach(order => {
          if ((order.status === 'done' || order.status === 'rejected') && !notifiedOrders.has(order.id)) {
            showNotification(order);
            notifiedOrders.add(order.id);
            // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ localStorage
            localStorage.setItem('notifiedOrders', JSON.stringify(Array.from(notifiedOrders)));
          }
        });
      });
    };

    let currentOrderIdForRating = null;
    let selectedRatingValue = 0;

    const showNotification = (order) => {
      const modal = document.getElementById('notificationModal');
      const msg = document.getElementById('notifMessage');
      const title = document.getElementById('notifTitle');

      currentOrderIdForRating = order.id;

      // Reset to step 1
      document.getElementById('ratingStep1').classList.remove('hidden');
      document.getElementById('ratingStep2').classList.add('hidden');
      document.getElementById('ratingStep3').classList.add('hidden');
      document.getElementById('notifActions').style.display = 'flex';

      if (order.status === 'done') {
        title.innerText = 'ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡! ğŸš€';
        msg.innerText = `Ù„Ù‚Ø¯ ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø·Ù„Ø¨Ùƒ (${order.tier}) Ø¨Ù†Ø¬Ø§Ø­. Ø´ÙƒØ±Ø§Ù‹ Ù„Ø«Ù‚ØªÙƒ Ø¨Ù†Ø§!`;
        document.getElementById('ratingContainer').classList.remove('hidden');
        setupRating();
      } else {
        title.innerText = 'ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨';
        msg.innerText = `Ø¹Ø°Ø±Ø§Ù‹ØŒ ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨Ùƒ (${order.tier}). ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ù„Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.`;
        document.getElementById('ratingContainer').classList.add('hidden');
      }

      modal.classList.add('visible');
    };

    const setupRating = () => {
      const stars = document.querySelectorAll('.star');
      const step1 = document.getElementById('ratingStep1');
      const step2 = document.getElementById('ratingStep2');
      const step3 = document.getElementById('ratingStep3');
      const submitBtn = document.getElementById('submitRatingBtn');
      const actions = document.getElementById('notifActions');

      selectedRatingValue = 0;
      document.getElementById('reviewText').value = '';

      stars.forEach(star => {
        star.classList.remove('active');
        star.onclick = () => {
          selectedRatingValue = parseInt(star.dataset.value);
          stars.forEach((s) => {
            if (parseInt(s.dataset.value) <= selectedRatingValue) s.classList.add('active');
            else s.classList.remove('active');
          });

          // Auto transition to step 2 after a small delay
          setTimeout(() => {
            step1.classList.add('hidden');
            step2.classList.remove('hidden');
            actions.style.display = 'none';
          }, 600);
        };
      });

      submitBtn.onclick = async () => {
        if (selectedRatingValue === 0) return;
        submitBtn.disabled = true;
        submitBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...";

        const review = document.getElementById('reviewText').value;
        const success = await submitRating(currentOrderIdForRating, selectedRatingValue, review);

        if (success) {
          step2.classList.add('hidden');
          step3.classList.remove('hidden');
          setTimeout(() => {
            actions.style.display = 'flex';
          }, 1000);
        } else {
          showToast("ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ….", "âŒ");
          submitBtn.disabled = false;
          submitBtn.innerText = "Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ";
        }
      };
    };

    window.closeNotification = () => {
      document.getElementById('notificationModal').classList.remove('visible');
    };


    window.handleLogin = login;
    window.handleLogout = logout;

    let lastOrders = null;
    function renderQueue(orders) {
      lastOrders = orders;
      queueList.innerHTML = '';
      if (orders.length === 0) {
        queueBrief.innerText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø­Ø¯ ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ± Ø­Ø§Ù„ÙŠØ§Ù‹. ÙƒÙ† Ø§Ù„Ø£ÙˆÙ„!";
        return;
      }

      const user = auth.currentUser;
      const myOrderIndex = orders.findIndex(o => o.uid === user?.uid);
      if (myOrderIndex !== -1) {
        queueBrief.innerText = myOrderIndex === 0 && orders[0].status === 'working'
          ? "Ø£Ù†Øª Ø§Ù„Ø£Ù† ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªÙ†ÙÙŠØ°! ğŸš€"
          : `Ø£Ù†Øª ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ² #${myOrderIndex + 1}ØŒ ÙŠÙˆØ¬Ø¯ ${myOrderIndex} Ù‚Ø¨Ù„Ùƒ.`;
      } else {
        queueBrief.innerText = `ÙŠÙˆØ¬Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ${orders.length} Ø·Ù„Ø¨Ø§Øª ÙÙŠ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±.`;
      }

      orders.forEach((order, index) => {
        const isWorking = order.status === 'working';
        const isPending = order.status === 'pending_verification';
        const isAwaiting = order.status === 'awaiting_payment';

        const item = document.createElement('div');
        item.className = `queue-item ${isWorking ? 'active' : ''} ${order.uid === user?.uid ? 'mine' : ''}`;

        let statusBadge = isWorking ? '<span style="font-size:0.8rem">ğŸ”¥ Ø¬Ø§Ø±Ù Ø§Ù„Ø¹Ù…Ù„</span>' : `#${index + 1}`;
        if (isPending) statusBadge = '<span style="font-size:0.75rem; color:var(--primary);">â³ Ø¬Ø§Ø±ÙŠ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„</span>';
        if (isAwaiting) statusBadge = '<span style="font-size:0.75rem; color:var(--text-dim);">ğŸ’¸ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹</span>';

        let workerInfo = '';
        if (isWorking && order.workerAvatar) {
          workerInfo = `
                    <div style="display:flex; align-items:center; gap:5px; font-size:0.75rem; color:var(--primary);">
                         <span>Ø¨ÙˆØ§Ø³Ø·Ø©:</span>
                         <img src="${order.workerAvatar}" style="width:20px; height:20px; border-radius:50%; border:1px solid var(--primary)" loading="lazy">
                         <span>${order.workerName.split(' ')[0]}</span>
                    </div>
                `;
        }

        const characters = order.characters || [{ name: order.charName, image: order.charImage }];

        // Show More Logic
        const limit = 6;
        const visibleChars = characters.slice(0, limit);
        const hiddenChars = characters.slice(limit);

        const generateCharTag = (c, hidden = false) => `
          <div class="${hidden ? `hidden-char-${order.id}` : ''}" style="${hidden ? 'display:none;' : 'display:inline-flex;'} align-items:center; gap:5px; background:rgba(255,255,255,0.05); padding:2px 8px; border-radius:10px; font-size:0.8rem;">
            ${c.image ? `<img src="${c.image}" style="width:16px; height:16px; border-radius:50%" loading="lazy">` : 'ğŸ—¡ï¸'}
            <span>${c.name}</span>
          </div>
        `;

        const visibleTags = visibleChars.map(c => generateCharTag(c)).join(' ');
        const hiddenTags = hiddenChars.map(c => generateCharTag(c, true)).join(' ');

        let moreBtn = '';
        if (hiddenChars.length > 0) {
          moreBtn = `
                <button onclick="document.querySelectorAll('.hidden-char-${order.id}').forEach(el => el.style.display='inline-flex'); this.style.display='none';" 
                    style="background:rgba(0, 242, 254, 0.1); border:1px solid var(--primary); color:white; border-radius:10px; padding:2px 8px; font-size:0.75rem; cursor:pointer;">
                    Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ (+${hiddenChars.length})
                </button>
            `;
        }

        item.innerHTML = `
                <div style="display:flex; flex-direction:column; flex:1">
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:5px;">
                        <img src="${order.userAvatar}" style="width:30px; height:30px; border-radius:50%" loading="lazy">
                        <strong>${order.userName.split(' ')[0]} - ${order.tier}</strong>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-right:40px;">
                        ${visibleTags}
                        ${hiddenTags}
                        ${moreBtn}
                    </div>
                    ${workerInfo}
                </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                    <span class="pos-tag" style="display:flex; flex-direction:column; align-items:flex-end;">
                        ${statusBadge}
                    </span>
                    ${(isAwaiting && order.uid === user?.uid) ? `
                      <div style="display:flex; gap:5px;">
                        <button onclick="resumePayment('${order.id}')" class="auth-btn" style="padding: 4px 10px; font-size: 0.7rem; border-radius: 8px; margin-top: 5px; background: var(--primary); color: #000; border: none;">
                          Ø§Ø³ØªÙƒÙ…Ø§Ù„ Ø§Ù„Ø¯ÙØ¹ ğŸ’³
                        </button>
                        <button onclick="cancelOrder('${order.id}')" class="auth-btn" style="padding: 4px 10px; font-size: 0.7rem; border-radius: 8px; margin-top: 5px; background: rgba(255, 77, 77, 0.2); color: #ff4d4d; border: 1px solid #ff4d4d;">
                          Ø¥Ù„ØºØ§Ø¡ ğŸ—‘ï¸
                        </button>
                      </div>
                    ` : ''}
                    ${(order.status === 'working' && order.uid === user?.uid) ? `
                      <button id="customer-chat-btn-${order.id}" onclick="openChat('${order.id}')" class="auth-btn" style="position:relative; padding: 4px 12px; font-size: 0.75rem; border-radius: 8px; margin-top: 5px; background: #4facfe; color: #fff; border: none; display:flex; align-items:center; gap:5px;">
                        <span>ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…ÙˆØ¸Ù</span> ğŸ’¬
                      </button>
                    ` : ''}
                </div>
            `;
        queueList.appendChild(item);

        if (isWorking && order.uid === user?.uid) {
          listenToUnreadCount(order.id, user.uid, (count) => {
            const btn = document.getElementById(`customer-chat-btn-${order.id}`);
            if (btn) {
              const existingBadge = btn.querySelector('.notification-badge');
              if (existingBadge) existingBadge.remove();

              if (count > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.innerText = count > 9 ? '9+' : count;
                btn.appendChild(badge);
              }
            }
          });
        }
      });
    }

    // --- Operations Modal Logic ---
    let opsUnsubscribe = null;
    const statusMap = {
      'awaiting_payment': 'ğŸ’¸ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¯ÙØ¹',
      'pending_verification': 'â³ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥ÙŠØµØ§Ù„',
      'waiting': 'â° Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡',
      'working': 'ğŸ”¥ Ø¬Ø§Ø±Ù Ø§Ù„Ø¹Ù…Ù„',
      'done': 'âœ… Ù…ÙƒØªÙ…Ù„',
      'rejected': 'âŒ Ù…Ø±ÙÙˆØ¶'
    };

    window.openOperationsModal = () => {
      document.getElementById('operationsModal').classList.add('visible');
      loadRecentOperations();
    };

    window.closeOperationsModal = () => {
      document.getElementById('operationsModal').classList.remove('visible');
      if (opsUnsubscribe) opsUnsubscribe();
    };

    function loadRecentOperations() {
      const opsList = document.getElementById('opsList');
      if (opsUnsubscribe) opsUnsubscribe();
      opsUnsubscribe = listenToAllOrdersExtended((orders) => {
        opsList.innerHTML = '';
        if (orders.length === 0) {
          opsList.innerHTML = '<div class="ops-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ù…Ø¤Ø®Ø±Ø§Ù‹.</div>';
          return;
        }
        orders.forEach(order => {
          const item = document.createElement('div');
          item.className = 'ops-item';
          item.onclick = () => viewOpDetails(order);
          item.innerHTML = `
                    <div class="ops-info">
                        <div class="ops-main">
                            <img src="${order.userAvatar || 'https://ui-avatars.com/api/?name=U'}" class="ops-avatar">
                            <span style="font-weight:bold;">${order.userName || 'Ù…Ø¬Ù‡ÙˆÙ„'}</span>
                        </div>
                        <div class="ops-id">${order.id}</div>
                        <div style="font-size:0.8rem; color:var(--primary);">${order.tier} - ${order.totalPrice} Ø¬Ù†ÙŠÙ‡</div>
                    </div>
                    <div class="ops-badge ${order.status}">${statusMap[order.status] || order.status}</div>
                `;
          opsList.appendChild(item);
        });
      });
    }

    window.handleOpsSearch = async () => {
      const input = document.getElementById('opsSearchInput');
      const orderId = input.value.trim();
      if (!orderId) return;
      const order = await getOrderById(orderId);
      if (order) viewOpDetails(order);
      else alert("Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯! ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙÙŠ ØµØ­ÙŠØ­.");
    };

    window.viewOpDetails = (order) => {
      const date = order.createdAt?.seconds ? new Date(order.createdAt.seconds * 1000).toLocaleString('ar-EG') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
      const chars = order.characters || [];
      const charNames = chars.map(c => `<li>${c.name} (${c.stars || '?'}â˜…)</li>`).join('');
      const content = `
            <div style="background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 15px; font-family: monospace; font-size: 0.8rem; color: var(--primary); text-align: center;">
                ${order.id}
            </div>
            <div style="display: grid; gap: 8px;">
                <div><strong>ğŸ‘¤ Ø§Ù„Ø¹Ù…ÙŠÙ„:</strong> ${order.userName}</div>
                <div><strong>ğŸ’ Ø§Ù„ÙØ¦Ø©:</strong> ${order.tier}</div>
                <div><strong>ğŸ’° Ø§Ù„Ø³Ø¹Ø±:</strong> ${order.totalPrice} Ø¬Ù†ÙŠÙ‡</div>
                <div><strong>ğŸ“Š Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${statusMap[order.status] || order.status}</div>
                <div><strong>ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${date}</div>
                ${order.workerName ? `<div><strong>âš™ï¸ Ø§Ù„Ù…Ù†ÙØ°:</strong> ${order.workerName}</div>` : ''}
                <div style="margin-top: 10px;">
                    <strong>âš”ï¸ Ø§Ù„Ø´Ø®ØµÙŠØ§Øª:</strong>
                    <ul style="margin: 5px 0; padding-right: 20px;">${charNames}</ul>
                </div>
            </div>
        `;
      document.getElementById('opsDetailsContent').innerHTML = content;
      document.getElementById('opsDetailsModal').classList.add('visible');
    };

    window.closeOpsDetailsModal = () => {
      document.getElementById('opsDetailsModal').classList.remove('visible');
    };

    listenToQueue(renderQueue);
  </script>
</body>

</html>